 <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Trading Control</title>

    <!-- Color de la barra de estado en móviles -->
    <meta name="theme-color" content="#1a1a1a">

    <!-- Enlace al Manifiesto de Aplicación Web (incrustado y corregido) -->
    <link rel="manifest" href="manifest.json">

    <!-- Icono para dispositivos Apple (muy importante para accesos directos) -->
    <link rel="apple-touch-icon" href="logo.jpg">

    <!-- Icono básico para pestañas de navegador (Favicon) -->
    <link rel="icon" type="image/jpeg" href="logo.jpg">

    <meta name="theme-color" content="#1a1a1a">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>


* {
    box-sizing: border-box;
}


 
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #00f2eab9;
            font-size: 24px;
        }

        h2 {
            color: #ffffff;
            font-size: 20px;
        }

        h3 {
            color: #00f2ea;
            font-size: 18px;
        }

        .account-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #2d2d2d;
            border-radius: 5px;
        }

        .account-controls select {
            flex-grow: 1;
            margin-right: 10px;
            background-color: #1a1a1a;
            border: 1px solid #4b5563;
            color: #ffffff;
            padding: 8px;
            border-radius: 4px;
        }

        .account-controls button {
            margin-left: 5px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #3a3a3a;
            border: none;
            flex: 1;
            text-align: center;
            color: #b3b3b3;
            transition: background-color 0.3s, color 0.3s;
        }

        .tab:hover {
            background-color: #00f2eaba;
            color: #000000;
        }

        .tab.active {
            background-color: #00f2eac7;
            color: #000000;
        }
   
        .tab-content {
              display: none;
         }
        .tab-content.active { 
                display: block;
          }

       .retos-seccion-bloque {
          margin-bottom: 2rem; /* Añade un espacio entre las secciones Semanal, Mensual e Historial */
        
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #b3b3b3;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #4b5563;
            border-radius: 4px;
            box-sizing: border-box;
            background-color: #1a1a1a;
            color: #ffffff;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00f2ea;
        }

        input::placeholder, textarea::placeholder {
            color: #6b7280;
        }

        input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
            -webkit-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            appearance: none;
            -webkit-appearance: none;
            margin: 0;
        }

        button {
            background-color: #00f2eaca;
            color: #000000;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #00d4d0c2;
        }

        .button-secondary {
            background-color: #58f5e8b7;
        }

        .button-secondary:hover {
            background-color: #166978;
        }

        .button-danger {
            background-color: #ef44bc;
        }

        .button-danger:hover {
            background-color: #dc2693bd;
        }

        .button-small {
            width: auto;
            padding: 5px 10px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #4b5563;
        }

        th {
            background-color: #2d2d2d;
            color: #b3b3b3;
        }

        tr:nth-child(even) {
            background-color: #1f1f1f;
        }

        .negative {
            color: #ef449f;
        }

        .positive {
            color: #10b0b9;
        }

        .warning {
            color: #f59e0b;
        }

        .operation-bullish {
            background-color: rgba(16, 185, 129, 0.1);
        }

        .operation-bearish {
            background-color: rgba(239, 68, 68, 0.1);
        }

        .filter-controls {
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .dashboard-card {
            background-color: #2d2d2d;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #4b5563;
            transition: box-shadow 0.3s;
        }

        .dashboard-card:hover {
            box-shadow: 0 4px 15px rgba(0, 242, 234, 0.2);
        }

        .card-stats {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .stat-box {
            background-color: #1f1f1f;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            flex: 1;
            min-width: 45%;
            margin: 5px;
            text-align: center;
        }

        .stat-box h4 {
            margin: 0 0 5px 0;
            color: #b3b3b3;
            font-size: 0.9em;
        }

        .stat-box p {
            margin: 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        .progress-container {
            width: 100%;
            background-color: #4b5563;
            border-radius: 5px;
            height: 20px;
            margin-top: 10px;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            border-radius: 5px;
            background-color: #10b9b9;
            transition: width 0.3s;
        }

        .progress-bar.warning {
            background-color: #f59e0b;
        }

        .progress-bar.danger {
            background-color: #ef44b9;
        }

        .progress-label {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            color: #ffffff;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
            line-height: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .consistency-warning {
            background-color: #fef3c7;
            color: #92400e;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 5px solid #f59e0b;
        }

        .drawdown-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #b3b3b3;
        }

        .drawdown-floor-warning {
            color: #ef44c4;
            font-weight: bold;
            margin-top: 10px;
        }

        .settings-modal, .details-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }
        input[type="date"], input[type="time"] {
            background-color: #75e8ecc2; /* Fondo blanco para contraste */
            color: #111111; /* Texto negro */
            border: 1px solid #333333; /* Borde visible */
            padding: 5px;
            font-size: 14px;
        }

        .modal-content {
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            margin: 20px 0;
            border: 1px solid #4b5563;
        }

        .close-modal {
            float: right;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            color: #b3b3b3;
        }

        .close-modal:hover {
            color: #ffffff;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .modal-buttons button {
            width: 48%;
        }

        .checklist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #listaTareas {
            list-style: none;
            padding: 0;
        }

        #listaTareas li {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #4b5563;
            font-size: 18px;
            background-color: #1f1f1f;
            margin-bottom: 5px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #listaTareas li.completed {
            background-color: rgba(37, 176, 191, 0.2);
        }

        #listaTareas input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            accent-color: #10b3b9;
        }

        #listaTareas .completed span {
            text-decoration: line-through;
            color: #6b7280;
        }

        #listaTareas .ok {
            margin-left: auto;
            color: #10abb9;
            font-weight: bold;
        }

        .objetivos-container {
            display: flex;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .objetivos-form, .objetivos-list {
            background-color: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #4b5563;
        }

        .objetivos-list .entry {
            background-color: #1f1f1f;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #4b5563;
        }

        .objetivos-list .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .objetivos-list .delete-entry {
            background-color: transparent;
            color: #ef44bf;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        .objetivos-list .delete-entry:hover {
            color: #dc268d;
        }

        .stars {
            display: flex;
            gap: 5px;
            font-size: 20px;
            cursor: pointer;
        }

        .star.selected {
            color: #f59e0b;
        }

        .media-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
            border-radius: 5px;
        }

        .media-preview img, .media-preview video {
            width: 100%;
            height: auto;
            object-fit: cover;
        }

        .entry-operations {
            margin-top: 10px;
            padding: 10px;
            background-color: #2d2d2d;
            border-radius: 5px;
        }

        .entry-operations table {
            width: 100%;
            border-collapse: collapse;
        }

        .entry-operations th, .entry-operations td {
            padding: 8px;
            border-bottom: 1px solid #4b5563;
        }

        .entry-operations th {
            background-color: #1f1f1f;
        }

        @media (max-width: 800px) {
            .objetivos-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 500px) {
            .container {
                padding: 15px;
            }
            h1 {
                font-size: 20px;
            }
            #listaTareas li {
                font-size: 16px;
            }
            #listaTareas input[type="checkbox"] {
                width: 18px;
                height: 18px;
            }
            .tabs {
                flex-direction: column;
            }
            .tab {
                border-bottom: 1px solid #4b5563;
            }
            .stat-box {
                min-width: 100%;
            }
        }
        .mood-input-container {
    position: relative;
 }

    .mood-icons {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      justify-content: flex-start;
}

    .mood-icon {
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: background-color 0.3s;
      user-select: none;
 }

    .mood-icon:hover {
      background-color: rgba(0, 242, 234, 0.2);
}
.show-all-selector {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 15px 0;
    gap: 10px;
}

.show-all-selector select {
    width: auto;
    padding: 8px 12px;
    font-size: 14px;
}
.percentage-50 {
    color: #ffffff; 
}

.percentage-below-50 {
    color: #ef44bc; 
}

.percentage-above-50 {
    color: #00f2ea;
}
/* --- ESTILOS GENERALES DE LA SECCIÓN RETOS --- */

.week-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 1rem 0;
    padding: 0 1rem;
}

.week-nav button {
    background-color: #3a3a3a;
    border: none;
    color: #b3b3b3;
    padding: 0.5rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: clamp(0.7rem, 2vw, 0.8rem);
    min-width: 60px;
    max-width: 80px;
    white-space: nowrap;
}

.week-nav button:hover {
    background-color: #00f2ea;
    color: #000000;
}

.week-nav button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #2d2d2d;
    color: #6b7280;
}

.current-week {
    font-weight: bold;
    font-size: clamp(0.9rem, 3vw, 1.1rem);
    color: #00f2ea;
    text-align: center;
    flex: 2;
    margin: 0 1rem;
}

.reto-section {
    background-color: #2d2d2d;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    border: 1px solid #4b5563;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
}

.reto-section h2 {
    color: #ffffff;
    margin-bottom: 1rem;
    font-size: clamp(1.2rem, 4vw, 1.5rem);
    font-weight: 600;
    width: 100%;
}

.reto-input {
    flex: 1;
    min-width: 200px;
    padding: 0.8rem;
    border: 1px solid #4b5563;
    border-radius: 4px;
    font-size: clamp(0.9rem, 3vw, 1rem);
    transition: all 0.3s ease;
    background-color: #1a1a1a;
    color: #ffffff;
    font-weight: 500;
    box-sizing: border-box;
}

.reto-input:focus {
    outline: none;
    border-color: #00f2ea;
}

.reto-input:disabled {
    background-color: #2d2d2d;
    cursor: not-allowed;
    opacity: 0.8;
    color: #6b7280;
}

.reto-input::placeholder {
    color: #6b7280;
}

/* --- NUEVO DISEÑO LINEAL PARA LOS DÍAS --- */

.dias-grid {
    display: flex;
    flex-direction: column; /* Apila los días verticalmente */
    gap: 0.8rem;
    margin: 1.8rem 0; /* Margen arriba y abajo */
    background-color: #2d2d2d;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #4b5563;
}

.dia-linea {
    display: grid;
    grid-template-columns: 100px 40px 40px 1fr; /* Día | ✓ | ✗ | Operativa */
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    border-radius: 5px;
    transition: background-color 0.3s;
}

.dia-linea:hover {
    background-color: #3a3a3a;
}

.dia-nombre-lineal {
    font-weight: 600;
    color: #b3b3b3;
    font-size: 0.9rem;
}

/* --- NUEVOS ESTILOS PARA BOTONES SEPARADOS --- */
.dia-reto-controles {
    display: flex;
    gap: 0.5rem; /* Espacio entre los dos botones */
    justify-content: center;
}

.btn-cumplido-check, .btn-no-cumplido-check {
    width: 32px;
    height: 32px;
    border-radius: 5px;
    cursor: pointer;
    border: 2px solid #4b5563;
    background-color: #3a3a3a;
    color: #b3b3b3;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s;
}

.btn-cumplido-check.active {
    background-color: #10b0b9;
    border-color: #10b0b9;
    color: white;
}

.btn-no-cumplido-check.active {
    background-color: #ef44bc;
    border-color: #ef44bc;
    color: white;
}


.resultado-selector-lineal select {
    width: 100%;
    max-width: 150px;
    padding: 0.5rem;
    font-size: 0.85rem;
    background-color: #1a1a1a;
    color: #ffffff;
    border: 1px solid #4b5563;
    border-radius: 4px;
}

/* --- ESTILOS PARA ESTADÍSTICAS, HISTORIAL Y OTROS --- */

.estadisticas {
    background-color: #2d2d2d;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1.8rem; /* Añadido para separar de los días */
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    border: 1px solid #4b5563;
}

.estadisticas h2 {
    color: #ffffff;
    margin-bottom: 1.2rem;
    font-size: clamp(1.2rem, 4vw, 1.5rem);
    font-weight: 600;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    text-align: center;
    padding: 1.2rem;
    background-color: #1f1f1f;
    border-radius: 5px;
    transition: all 0.3s ease;
    border: 1px solid #4b5563;
}

.stat-card:hover {
    transform: translateY(-0.1rem);
    box-shadow: 0 4px 15px rgba(0, 242, 234, 0.2);
}

.stat-number {
    font-size: clamp(1.5rem, 5vw, 1.8rem);
    font-weight: 700;
    color: #00f2ea;
    margin-bottom: 0.3rem;
}

.stat-label {
    font-size: clamp(0.75rem, 2.5vw, 0.85rem);
    color: #b3b3b3;
    font-weight: 500;
}

.chart-container {
    position: relative;
    height: 300px;
    background-color: #1f1f1f;
    border-radius: 5px;
    padding: 1.5rem;
    margin-top: 1.5rem; /* Separación del grid de stats */
    border: 1px solid #4b5563;
}

.historial {
    background-color: #2d2d2d;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1.8rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    border: 1px solid #4b5563;
}

.historial h2 {
    color: #ffffff;
    margin-bottom: 1.2rem;
    font-size: clamp(1.2rem, 4vw, 1.5rem);
    font-weight: 600;
}

.historial-item {
    padding: 1rem;
    border-bottom: 1px solid #4b5563;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
    border-radius: 5px;
    margin-bottom: 0.3rem;
}

.historial-item:hover {
    background-color: #1f1f1f;
    transform: translateX(0.3rem);
}

.historial-item:last-child {
    border-bottom: none;
}

.historial-fecha {
    font-weight: 600;
    color: #00f2ea;
    font-size: clamp(0.9rem, 3vw, 1rem);
}

.historial-stats {
    font-size: clamp(0.8rem, 2.5vw, 0.9rem);
    color: #b3b3b3;
    margin-top: 0.2rem;
}

.historial-reto {
    font-size: clamp(0.7rem, 2vw, 0.8rem);
    color: #b3b3b3;
    margin-top: 0.3rem;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.btn-ver-semana, .btn-eliminar-semana {
    background-color: #00f2ea;
    color: #000000;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: clamp(0.7rem, 2vw, 0.8rem);
    font-weight: 500;
    transition: all 0.3s ease;
    margin: 0.2rem;
}

.btn-eliminar-semana {
    background-color: #ef44bc;
    color: #ffffff;
}

.btn-ver-semana:hover {
    background-color: #00d4d1;
    transform: translateY(-1px);
}

.btn-eliminar-semana:hover {
    background-color: #dc2693;
    transform: translateY(-1px);
}

.guardar-section {
    text-align: center;
    margin: 1.5rem 0;
    padding: 1.2rem;
}

.btn-finalizar {
    background-color: #00f2ea;
    color: #000000;
    border: none;
    padding: clamp(0.8rem, 3vw, 1rem) clamp(1.2rem, 4vw, 1.8rem);
    border-radius: 4px;
    font-size: clamp(0.85rem, 3vw, 1rem);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 10px rgba(0, 242, 234, 0.3);
    min-width: clamp(150px, 40vw, 200px);
    display: none;
}

.btn-finalizar:hover {
    background-color: #00d4d1;
    transform: translateY(-1px);
}

.btn-editar-reto, .btn-guardar-reto {
    background-color: #00f2ea;
    color: #000000;
    border: none;
    padding: 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: clamp(0.8rem, 2.5vw, 0.9rem);
    transition: all 0.3s ease;
    min-width: 3rem;
    display: none;
    align-items: center;
    justify-content: center;
}

.btn-editar-reto:hover, .btn-guardar-reto:hover {
    background-color: #00d4d1;
    transform: translateY(-1px);
}

.btn-guardar-reto {
    background-color: #10b0b9;
    color: #ffffff;
}

.btn-guardar-reto:hover {
    background-color: #0e9da6;
}

.monthly-stats {
    background-color: #2d2d2d;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 1.8rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    border: 1px solid #4b5563;
}

.month-selector {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 1.2rem;
    margin-bottom: 1.5rem;
}

.month-selector button {
    background-color: #00f2ea;
    color: #000000;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    font-size: clamp(0.8rem, 2.5vw, 0.9rem);
}

.month-selector button:hover {
    background-color: #00d4d1;
    transform: translateY(-1px);
}

.progress-fill {
    height: 100%;
    background-color: #10b0b9;
    transition: width 0.5s ease;
    border-radius: 5px;
}

/* --- Media Queries para Responsividad --- */

@media (max-width: 768px) {
   

    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    }

    .month-selector {
        flex-direction: column;
        gap: 0.8rem;
    }

    .reto-section {
        flex-direction: column;
    }

    .reto-input {
        min-width: 100%;
    }

    .btn-editar-reto, .btn-guardar-reto {
        width: 100%;
    }
}

@media (max-width: 500px) {
    .dia-linea {
        grid-template-columns: 80px 35px 1fr; /* Ajuste para móviles */
        gap: 0.8rem;
    }

    .btn-finalizar {
        padding: 0.6rem 1rem;
        font-size: clamp(0.75rem, 2.5vw, 0.9rem);
        min-width: 120px;
    }
}
/* --- AÑADE ESTAS REGLAS PARA LOS TÍTULOS --- */
.dias-grid-header {
    display: grid;
    grid-template-columns: 100px 90px 90px 1fr; /* Día | ✓ | ✗ | Operativa */
    align-items: center;
    gap: 1rem;
    padding: 0 0.5rem 0.5rem; /* Padding solo abajo */
    border-bottom: 1px solid #4b5563; /* Línea separadora */
    margin-bottom: 0.5rem;
}

.dias-grid-header span {
    font-size: 0.8rem;
    font-weight: bold;
    color: #b3b3b3;
    text-transform: uppercase;
    text-align: center;
}

/* Alineamos el primer título (Día) a la izquierda */
.dias-grid-header span:first-child {
    text-align: left;
}

/* --- REGLA AÑADIDA --- */
/* Alineamos el último título (Operativa) a la izquierda para que coincida con el selector */
.dias-grid-header span:last-child {
    text-align: left;
}



    </style>
</head>
<body>
    <div class="container">
        <h1>Trading Control</h1>
        <div class="account-controls">
            <select id="account-selector" onchange="setActiveAccount(this.value)"></select>
            <button onclick="openCreateAccountModal()" class="button-small button-secondary">Nueva Cuenta</button>
            <button onclick="confirmDeleteAccount()" class="button-small button-danger">Eliminar</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="openTab('dashboard')">Dashboard</button>
            <button class="tab" onclick="openTab('checklist')">Checklist</button>
            <button class="tab" onclick="openTab('registro')">Registro</button>
            <button class="tab" onclick="openTab('historial')">Historial</button>
            <button class="tab" onclick="openTab('objetivos')">Objetivos</button>
            <button class="tab" onclick="openTab('Retos')">Retos Semanales</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-card">
                <h3>Resumen de Cuenta</h3>
                <div class="card-stats">
                    <div class="stat-box"><h4>Saldo Inicial</h4><p id="initial-balance-display">0.00 €</p></div>
                    <div class="stat-box"><h4>Saldo Actual</h4><p id="current-balance">0.00 €</p></div>
                    <div class="stat-box"><h4>Ganancia/Pérdida</h4><p id="profit-loss">0.00 €</p></div>
                    <div class="stat-box"><h4>Rentabilidad</h4><p id="roi">0.00%</p></div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button onclick="openSettingsModal()" class="button-secondary button-small">Ajustes</button>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>Seguimiento de Drawdown</h3>
                <div class="card-stats">
                    <div class="stat-box"><h4>Pico de Saldo (HWM)</h4><p id="high-water-mark">0.00 €</p></div>
                    <div class="stat-box"><h4>Suelo Drawdown</h4><p id="drawdown-floor">0.00 €</p></div>
                    <div class="stat-box"><h4>Margen hasta Suelo</h4><p id="margin-to-floor">0.00 €</p></div>
                </div>
                <p class="drawdown-info" id="drawdown-explanation">El suelo de drawdown es el saldo mínimo permitido.</p>
            </div>
            <div class="dashboard-card">
                <h3 id="consistency-title">Regla de Consistencia</h3>
                <p>El día más rentable no debe superar el <span id="consistency-limit-display">40</span>% de las ganancias totales.</p>
                <div id="consistency-rule-container">
                    <div class="progress-container">
                        <div id="consistency-progress" class="progress-bar" style="width: 0%"></div>
                        <div class="progress-label">0%</div>
                    </div>
                    <p id="consistency-details" style="margin-top: 10px; font-size: 0.9em;">No hay suficientes datos para calcular la consistencia.</p>
                </div>
            </div>
            <div class="dashboard-card">
                <h3>Objetivos</h3>
                <div class="card-stats">
                    <div class="stat-box"><h4>Objetivo Semanal</h4><p id="weekly-goal-display">0.00 €</p>
                    <p id="weekly-progress-percentage">0%</p></div>
                    <div class="stat-box"><h4>Objetivo Mensual</h4><p id="monthly-goal-display">0.00 €</p>
                    <p id="monthly-progress-percentage">0%</p></div>
                </div>
             
                    <h3 style="margin-top: 20px;">Metas</h3>
                    <div id="journal-entries"></div>
            </div>
                  <div class="dashboard-card">
               <h3>Crecimiento de Capital y Seguimiento de Drawdown</h3>
               <div class="chart-container">  
              <canvas id="capitalGrowthChart"></canvas>
                </div>
            </div>
        
            
            <div class="dashboard-card">
                <h3>Operaciones Recientes</h3>
                <div id="recent-operations"><p>No hay operaciones recientes para mostrar.</p></div>
            </div>
      
        </div>
        <!-- Checklist -->
     <!-- Checklist -->
<div id="checklist" class="tab-content">
    <div class="checklist-header">
        <h2>Checklist Personal - Classroom</h2>
        <div>
            <!-- Nuevos botones para editar y añadir tareas -->
            <button id="edit-checklist-btn" onclick="toggleChecklistEditMode()" class="button-secondary button-small">Editar Lista</button>
            <button id="save-checklist-btn" onclick="saveChecklistChanges()" class="button-secondary button-small" style="display:none;">Guardar Cambios</button>
            <button onclick="resetChecklist()" class="button-danger button-small">Resetear Checklist</button>
        </div>
    </div>
    <ul id="listaTareas">
        <!-- Las tareas se cargarán aquí -->
    </ul>
    <!-- Formulario para añadir nueva tarea (oculto por defecto) -->
    <div id="add-task-container" class="form-group" style="display:none; margin-top: 20px;">
        <input type="text" id="new-task-input" placeholder="Escribe el texto de la nueva tarea">
        <button onclick="addNewChecklistItem()" style="margin-top: 10px;">Añadir Tarea</button>
    </div>
</div>
       <!-- Registro  -->
<div id="registro" class="tab-content">
    <form id="trading-form">
        <div class="form-group"><label for="date">Fecha:</label><input type="date" id="date"></div>
        <div class="form-group">
            <label for="type">Tipo de operación (Opcional):</label>
            <select id="type">
                <option value="">Seleccionar...</option>
                <option value="bullish">Alcista (Compra)</option>
                <option value="bearish">Bajista (Venta)</option>
            </select>
        </div>
         <div class="form-group">
            <label for="activo">Activo:</label>
            <select id="activo" name="activo" onchange="handleAssetSelection(this)"> >
                <option value="">Seleccionar...</option>
                <option value="Nasdaq">Nasdaq</option>
                <option value="Oro">Oro</option>
                <option value="Dax">Dax</option>
                <option value="custom">Otro (especificar)</option>
            </select>
            <input type="text" id="custom-activo-input" style="display: none; margin-top: 10px;" 
            placeholder="Escribe el nombre del activo">
        </div>
        <div class="form-group">
            <label for="estrategia">Estrategia:</label>
            <select id="estrategia" name="estrategia" onchange="handleAssetSelection(this)">
                <option value="">Seleccionar...</option>
                <option value="Flash">Flash</option>
                <option value="Monarca">Monarca</option>
                <option value="Monarca Plus">Monarca Plus</option>
                <option value="Imperial">Imperial</option>
                <option value="Golden">Golden</option>
                <option value="Golden Band">Golden Band</option>
                <option value="custom">Otro (especificar)</option>
            </select>
            <input type="text" id="custom-estrategia-input" style="display: none; margin-top: 10px;" 
            placeholder="Escribe el nombre de la estrategia">
        </div>
        <div class="form-group">
            <label for="contracts">Número de contratos:</label>
            <input type="number" id="contracts" step="1" min="0" placeholder="Ej: 1, 2, 5">
        </div>
        <div class="form-group">
            <label for="entry-time">Hora de entrada (Opcional):</label>
            <input type="time" id="entry-time" step="1"><small>Incluye segundos (hh:mm:ss)</small>
        </div>
        <div class="form-group">
            <label for="exit-time">Hora de salida (Opcional):</label>
            <input type="time" id="exit-time" step="1"><small>Incluye segundos (hh:mm:ss)</small>
        </div>
        <div class="form-group">
            <label for="amount">Importe (positivo si ganancia, negativo si pérdida):</label>
            <input type="text" inputmode="text" pattern="-?[0-9]*\.?[0-9]+" id="amount" step="any"
             required placeholder="Ej: 150.50 o -75.20">
        </div>
        <div class="form-group">
            <label for="entry-type">Tipo de entrada:</label>
            <select id="entry-type" name="entry-type" onchange="handleAssetSelection(this)">
                <option value="">Seleccionar...</option>
                <option value="En la zona">En la zona</option>
                <option value="Precipitada">Precipitada</option>
                <option value="Tarde">Tarde</option>
                <option value="Por rebote">Por rebote</option>
                <option value="En ruptura (breakout)">En ruptura (breakout)</option>
                <option value="En pullback">En pullback</option>
                <option value="En continuación">En continuación</option>
                <option value="En reversión">En reversión</option>
                <option value="Planificada">Planificada</option>
                <option value="Impulsiva">Impulsiva</option>
                <option value="Forzada">Forzada</option>
                <option value="Por confirmación">Por confirmación</option>
                <option value="custom">Otro (especificar)</option>
            </select>
            <input type="text" id="custom-entry-type-input" style="display: none; margin-top: 10px;" 
            placeholder="Escribe el tipo de entrada">
        </div>
        <div class="form-group">
            <label for="exit-type">Tipo de salida:</label>
            <select id="exit-type" name="exit-type" onchange="handleAssetSelection(this)">
                <option value="">Seleccionar...</option>
                <option value="Por objetivo (take profit)">Por objetivo (take profit)</option>
                <option value="Por stop loss">Por stop loss</option>
                <option value="Por trailing stop">Por trailing stop</option>
                <option value="Por tiempo">Por tiempo</option>
                <option value="Por reversión">Por reversión</option>
                <option value="Por señal técnica">Por señal técnica</option>
                <option value="Por cierre de mercado">Por cierre de mercado</option>
                <option value="Prematura">Prematura</option>
                <option value="Tardía">Tardía</option>
                <option value="Por pánico">Por pánico</option>
                <option value="custom">Otro (especificar)</option>
            </select>
            <input type="text" id="custom-exit-type-input" style="display: none; margin-top: 10px;" 
            placeholder="Escribe el tipo de salida">
        </div>
         <div class="form-group">
<label for="journal-news">Valoración de Noticias:</label>
<div class="stars">
    <span class="star" data-value="0" onclick="setNewsRating(0)">☆</span>
    <span class="star" data-value="1" onclick="setNewsRating(1)">☆</span>
    <span class="star" data-value="2" onclick="setNewsRating(2)">☆</span>
    <span class="star" data-value="3" onclick="setNewsRating(3)">☆</span>
    <span class="star" data-value="4" onclick="setNewsRating(4)">☆</span>
</div>
<input type="hidden" id="journal-news" value="0"></div>
<div class="form-group">
            <label for="journal-mood">Estado de Ánimo:</label>
            <div class="mood-input-container">
                <input type="text" id="journal-mood" placeholder="Escribe tu estado de ánimo o usa los iconos">
                <div class="mood-icons">
                    <span class="mood-icon" onclick="setMood('😊 Feliz')" title="Feliz">😊</span>
                    <span class="mood-icon" onclick="setMood('😐 Neutral')" title="Neutral">😐</span>
                    <span class="mood-icon" onclick="setMood('😟 Triste')" title="Triste">😟</span>
                    <span class="mood-icon" onclick="setMood('😠 Enfadado')" title="Enfadado">😠</span>
             </div>
   </div>
</div>
<div class="form-group">
      <label for="trade-media">Foto/Video de la Operación (Opcional):</label>
     <input type="file" id="trade-media" accept="image/*,video/*">
     <small>Solo se aceptan imágenes (jpg, png) </small>
</div>

 <div class="form-group"><label for="notes">Notas (Opcional):</label>
                <textarea id="notes" rows="3"></textarea></div>
            <button type="submit">Guardar Operación</button>
        </form>
 </div>
 
<!-- Historial  -->
 <div id="historial" class="tab-content">
        <div class="filter-controls">
            <div class="form-group"><label for="filter-year">Filtrar por año:</label><select id="filter-year" onchange="filterOperations()"></select></div>
            <div class="form-group">
                <label for="filter-month">Filtrar por mes:</label>
                <select id="filter-month" onchange="filterOperations()">
                    <option value="">Todos</option>
                    <option value="01">Enero</option><option value="02">Febrero</option><option value="03">Marzo</option>
                    <option value="04">Abril</option><option value="05">Mayo</option><option value="06">Junio</option>
                    <option value="07">Julio</option><option value="08">Agosto</option><option value="09">Septiembre</option>
                    <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filter-type">Filtrar por tipo:</label>
                <select id="filter-type" onchange="filterOperations()">
                    <option value="">Todos</option><option value="bullish">Alcista</option><option value="bearish">Bajista</option>
                    <option value="other">Otro</option><option value="none">Sin tipo</option>
                </select>
            </div>
            <div class="form-group">
                <label for="filter-result">Filtrar por resultado:</label>
                <select id="filter-result" onchange="filterOperations()">
                    <option value="">Todos</option><option value="win">Ganancia</option><option value="loss">Pérdida</option><option value="neutral">Neutral</option>
                </select>
            </div>
        </div>
        <div class="show-all-selector">
    <label for="operations-display">Mostrar:</label>
    <select id="operations-display" onchange="changeOperationsDisplay()">
        <option value="4" selected>Últimas 4 operaciones</option>
        <option value="-1">Todas las operaciones</option>
    </select>
</div>
        <div style="overflow-x: auto;">
            <table id="operations-table">
                <thead>
          <th>Fecha</th><th>Tipo</th><th>Activo</th><th>Estrategia</th><th>Contratos</th><th>Tipo Entrada</th><th>Tipo Salida</th><th>Duración</th><th>Ánimo</th>
          <th>Importe</th><th>Media</th><th>Acciones</th>
                </thead>
                <tbody id="operations-list"></tbody>
            </table>
        </div>
        
        <div class="dashboard-card">
            <h3>Operaciones por Día de la Semana</h3>
            <div class="card-stats" id="weekly-performance"></div>
            <div class="dashboard-card">
            <h3>Porcentaje de Aciertos por Día de la Semana</h3>
          <div class="card-stats" id="weekly-success-rate"></div>
       </div>
        </div>
       
        <div class="dashboard-card" style="margin-top: 30px;">
            <h3>Historial de Metas Conseguidas</h3>
            <p>Aquí se muestran las metas que has completado. ¡Sigue así!</p>
            <div id="historial-metas-conseguidas">
                <!-- Las metas completadas se cargarán aquí -->
            </div>
        </div>
      

 </div>


        <!-- Objetivos -->
<div id="objetivos" class="tab-content">
            <div class="objetivos">
                <div class="objetivos">
                    <h3>Metas</h3>
                    <div class="form-group">
                        <label for="journal-date">Fecha:</label>
                        <input type="date" id="journal-date" required min="2020-01-01">
                    </div>
                    <div class="form-group">
                        <label for="journal-title">Metas:</label>
                        <input type="text" id="journal-title" placeholder="Escribe tu meta">
                         <button onclick="saveJournalEntry()">Guardar Meta</button>
                </div>
                    </div>
             <div class="form-group">
                     
                <div class="objetivos">
                    <h3>Objetivos</h3>
                    <div class="form-group">
                        <label for="weekly-goal">Objetivo Semanal (€):</label>
                        <input type="number" id="weekly-goal" step="0.01" placeholder="Ej: 1000">
                        <p id="weekly-progress-detailed">Progreso: 0.00 € / 0.00 € (0%)</p>
                    </div>
                    <div class="form-group">
                        <label for="monthly-goal">Objetivo Mensual (€):</label>
                        <input type="number" id="monthly-goal" step="0.01" placeholder="Ej: 4000">
                        <p id="monthly-progress-detailed">Progreso: 0.00 € / 0.00 € (0%)</p>
                    </div>
                    <button onclick="saveGoals()">Guardar Objetivos</button>
                   
                    <div class="card-stats" id="journal-stats-container"></div>
                    
                </div>
            </div>
        </div>
</div>
  
<!-- Retos Semanales -->
<div id="Retos" class="tab-content">

    <div class="content">

        <!-- SECCIÓN SEMANAL -->
        <div class="retos-seccion-bloque">
            <div class="header">
                <div class="week-nav" id="weekNav">
                    <button id="prevWeek">← Anterior</button>
                    <div class="current-week" id="currentWeekDisplay"></div>
                    <button id="nextWeek">Siguiente →</button>
                </div>
            </div>

            <!-- 1. Sección del Reto (con el div correctamente cerrado) -->
            <div class="reto-section">
                <h2>🎯 Reto de la Semana</h2>
                <div style="display: flex; gap: 10px; align-items: center; width: 100%;">
                    <input type="text" id="retoInput" class="reto-input" placeholder="Define tu reto para esta semana..." disabled>
                    <button id="btnEditarReto" class="btn-editar-reto" style="display: none;">✏️</button>
                    <button id="btnGuardarReto" class="btn-guardar-reto" style="display: none;">💾</button>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: #6c757d; width: 100%;">
                    <em>El reto se guarda automáticamente y se puede editar.</em>
                </div>
            </div> <!-- CIERRE DEL DIV .reto-section -->

            <!-- 2. Grid de Días -->
            <div class="dias-grid" id="diasGrid">
                <div class="dias-grid-header">
                    <span>Día</span>
                    <span>Reto</span>
                    <span>Operativa</span>
                </div>
                <!-- Los días se generarán dinámicamente aquí -->
            </div>

            <!-- 3. Botón Finalizar Semana -->
            <div class="guardar-section">
                <button id="btnGuardarHistorial" class="btn-finalizar" style="display: none;">Finalizar Semana</button>
            </div>

            <!-- 4. Estadísticas Semanales -->
            <div class="estadisticas">
                <h2>📊 Estadísticas de la Semana</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="diasCumplidos">0</div><div class="stat-label">Días Cumplidos</div></div>
                    <div class="stat-card"><div class="stat-number" id="resultadosPositivos">0</div><div class="stat-label">Resultados +</div></div>
                    <div class="stat-card"><div class="stat-number" id="resultadosNegativos">0</div><div class="stat-label">Resultados -</div></div>
                    <div class="stat-card"><div class="stat-number" id="porcentajeCumplimiento">0%</div><div class="stat-label">% Cumplimiento</div></div>
                    <div class="stat-card"><div class="stat-number" id="efectividad">0%</div><div class="stat-label">% Efectividad</div></div>
                </div>
                <div class="chart-container">
                    <canvas id="chartCanvas"></canvas>
                </div>
            </div>
        </div>

        <!-- SECCIÓN MENSUAL -->
        <div class="retos-seccion-bloque">
            <div class="monthly-stats">
                <h2>📈 Estadísticas Mensuales</h2>
                <div class="month-selector">
                    <button id="prevMonthBtn">← Mes Anterior</button>
                    <h3 id="currentMonth"></h3>
                    <button id="nextMonthBtn">Mes Siguiente →</button>
                   <button id="toggleTotalViewBtn" style="background-color: var(--accent-secondary);">Ver Todo</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-number" id="semanasDelMes">0</div><div class="stat-label">Semanas Registradas</div></div>
                    <div class="stat-card"><div class="stat-number" id="diasCumplidosMes">0</div><div class="stat-label">Total Días Cumplidos</div></div>
                    <div class="stat-card"><div class="stat-number" id="positivosMes">0</div><div class="stat-label">Resultados Positivos</div></div>
                    <div class="stat-card"><div class="stat-number" id="cumplimientoMes">0%</div><div class="stat-label">% Cumplimiento Mes</div></div>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- SECCIÓN HISTORIAL -->
        <div class="retos-seccion-bloque">
            <div class="historial">
                <h2>📅 Historial Completo</h2>
                <div style="text-align: center; margin: 20px 0;">
                  <button id="btnBorrarHistorial" class="button-danger">Borrar Historial</button>
                </div>
                <div id="historialContainer"></div>
            </div>
        </div>
    </div>
</div>

        <!-- Modals -->
        <div id="settings-modal" class="settings-modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeSettingsModal()">&times;</span>
                <h2>Configuración de Cuenta</h2>
                <div class="form-group">
                    <label for="initial-balance">Saldo Inicial (€):</label>
                    <input type="number" id="initial-balance" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="trailing-drawdown-amount">Importe Drawdown Trailing/EOD (€):</label>
                    <input type="number" id="trailing-drawdown-amount" step="0.01" min="0">
                    <small>Importe fijo de drawdown permitido (Ej: 2500 para cuenta de 50k).</small>
                </div>
                <div class="form-group">
                    <label for="consistency-percentage">Porcentaje de Consistencia (%):</label>
                    <input type="number" id="consistency-percentage" step="1" min="1" max="100">
                    <small>Porcentaje máximo del día más rentable sobre ganancias totales.</small>
                </div>
                <div class="modal-buttons">
                    <button class="button-danger" onclick="resetAllData()">Reiniciar Datos</button>
                    <button class="button-secondary" onclick="saveSettings()">Guardar</button>
                </div>
            </div>
        </div>
        <div id="details-modal" class="details-modal">
         <div class="modal-content">
            <span class="close-modal" onclick="closeDetailsModal()">&times;</span>
            <h2>Detalles de la Operación</h2>
             <div id="operation-details-content"></div>
           <div class="modal-buttons">
            <button onclick="closeDetailsModal()">Cerrar</button>
          </div>
         </div>
        </div>
    

    <script>
        // --- Constants ---
        const ACCOUNTS_KEY = 'tradingAccounts';
        const ACTIVE_ACCOUNT_KEY = 'tradingActiveAccount';
       
function getChecklistItemsForAccount() {
    const key = `checklist_items_${currentAccountId}`;
    const storedItems = localStorage.getItem(key);
    
    if (storedItems) {
        return JSON.parse(storedItems);
    } else {
        // Lista por defecto para cuentas nuevas
        return [
            "RITHMIC (CORTAFUEGO)",
            "NINJA CUENTA REAL",
            "REPLICADOR Y GESTOR",
            "NOTICIAS",
            "LECTURA DEL MERCADO",
            "ATM CORRECTOS",
            "GRAFICA",
            "DIARIO DE TRADING",
            "REVISIÓN"
        ];
    }
}

        // --- State toggleGoalAchieved    ---
        let accounts = [];
        let currentAccountId = null;
        let operations = [];
        let settings = { initialBalance: 50000, consistencyPercentage: 40, trailingDrawdownAmount: 2500 };
        let journals = [];
        let goals = { weekly: 0, monthly: 0 };
        let highWaterMark = 0;
        let drawdownFloor = 0;
        let showAllOperations = false;

        // --- Helpers ---
        function formatCurrency(value) {
            return (typeof value === 'number' ? value.toFixed(2) : '0.00') + ' €';
        }

        function formatPercentage(value) {
            return (typeof value === 'number' ? value.toFixed(2) : '0.00') + '%';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                return new Date(dateString + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
            } catch (e) {
                return 'Fecha Inválida';
            }
        }

        function formatType(type) {
            switch (type) {
                case 'bullish': return '<span class="positive">Alcista</span>';
                case 'bearish': return '<span class="negative">Bajista</span>';
                case 'other': return '<span>Otro</span>';
                default: return '<em>N/A</em>';
            }
        }

        function parseAmount(value) {
            if (typeof value !== 'string') return NaN;
            const cleanedValue = value.replace(/\s/g, '').replace(',', '.');
            const number = parseFloat(cleanedValue);
            return isNaN(number) ? NaN : number;
        }

        function calculateDuration(entryTime, exitTime) {
            if (!entryTime || !exitTime) return 'N/A';
            entryTime = entryTime.split(':').length === 2 ? entryTime + ':00' : entryTime;
            exitTime = exitTime.split(':').length === 2 ? exitTime + ':00' : exitTime;
            if (!/^\d{2}:\d{2}:\d{2}$/.test(entryTime) || !/^\d{2}:\d{2}:\d{2}$/.test(exitTime)) return 'Formato Inválido';
            try {
                const [entryH, entryM, entryS] = entryTime.split(':').map(Number);
                const [exitH, exitM, exitS] = exitTime.split(':').map(Number);
                let durationS = (exitH * 3600 + exitM * 60 + exitS) - (entryH * 3600 + entryM * 60 + entryS);
                if (durationS < 0) return 'Revisar Horas';
                const h = Math.floor(durationS / 3600), m = Math.floor((durationS % 3600) / 60), s = durationS % 60;
                return `${h}h ${m}m ${s}s`;
            } catch (e) {
                return 'Error Cálculo';
            }
        }

      function readFileAsDataURL(file, callback) {
    if (!file) {
        return callback(null);
    }

    // --- Lógica de Compresión de Imágenes ---
    // Si el archivo es una imagen, la procesamos. Si es un vídeo, lo ignoramos.
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Define las nuevas dimensiones máximas
                const MAX_WIDTH = 800;
                const MAX_HEIGHT = 600;
                
                let width = img.width;
                let height = img.height;
                
                // Calcula las nuevas dimensiones manteniendo la proporción
                if (width > height) {
                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }
                } else {
                    if (height > MAX_HEIGHT) {
                        width *= MAX_HEIGHT / height;
                        height = MAX_HEIGHT;
                    }
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Dibuja la imagen redimensionada en el canvas
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convierte el canvas a un DataURL de imagen JPG con calidad del 75%
                // El formato 'image/jpeg' es más eficiente en espacio que 'image/png'
                const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.75);
                
                // Devuelve la imagen comprimida
                callback(compressedDataUrl);
            };
        };
        
        reader.readAsDataURL(file);

    } else if (file.type.startsWith('video/')) {
        // Si es un vídeo, avisamos que no se puede y lo descartamos.
        alert('Los vídeos no se pueden adjuntar para ahorrar espacio. Por favor, añade una referencia en las notas.');
        callback(null); // Devolvemos null para que no se guarde nada.
        return;

    } else {
        // Si no es ni imagen ni vídeo, lo ignoramos.
        callback(null);
    }
}


        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 3 - (d.getDay() + 6) % 7);
            const week1 = new Date(d.getFullYear(), 0, 4);
            return Math.round(((d - week1) / 86400000 + 1) / 7) + 1;
        }

        function getDayOfWeek(dateString) {
            const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            return days[new Date(dateString).getDay()];
        }

        // --- Checklist ---
        function getChecklistKey() {
            const today = new Date().toISOString().split('T')[0];
            return `checklist_${currentAccountId}_${today}`;
        }

       function showChecklist(isEditMode = false) {
    const checklistItems = getChecklistItemsForAccount();
    const checklistKey = getChecklistKey(); // Clave para el estado (marcado/no marcado)
    let estadoTareas = JSON.parse(localStorage.getItem(checklistKey)) || checklistItems.map(() => false);

    const lista = document.getElementById('listaTareas');
    lista.innerHTML = '';

    checklistItems.forEach((tarea, index) => {
        const li = document.createElement('li');
        li.className = estadoTareas[index] ? 'completed' : '';
        
        if (isEditMode) {
            // MODO EDICIÓN: Muestra un campo de texto y un botón de borrar
            li.innerHTML = `
                <input type="text" class="checklist-edit-input" value="${tarea}" data-index="${index}">
                <button class="button-danger button-small" onclick="removeChecklistItem(${index})">Eliminar</button>
            `;
        } else {
            // MODO NORMAL: Muestra el checkbox y el texto
            li.innerHTML = `
                <input type="checkbox" ${estadoTareas[index] ? 'checked' : ''} 
                       onchange="markChecklistItem(${index}, this)">
                <span>${tarea}</span>
                ${estadoTareas[index] ? '<span class="ok">OK</span>' : ''}
            `;
        }
        lista.appendChild(li);
    });
}
// Variable para controlar el estado de edición
let isChecklistEditMode = false;

function toggleChecklistEditMode() {
    isChecklistEditMode = !isChecklistEditMode; // Invierte el estado (true/false)
    
    // Muestra u oculta los botones y el formulario de añadir tarea
    document.getElementById('edit-checklist-btn').style.display = isChecklistEditMode ? 'none' : 'inline-block';
    document.getElementById('save-checklist-btn').style.display = isChecklistEditMode ? 'inline-block' : 'none';
    document.getElementById('add-task-container').style.display = isChecklistEditMode ? 'block' : 'none';
    
    // Vuelve a dibujar el checklist en el modo correspondiente
    showChecklist(isChecklistEditMode);
}

function saveChecklistChanges() {
    const inputs = document.querySelectorAll('.checklist-edit-input');
    const newChecklistItems = [];
    inputs.forEach(input => {
        newChecklistItems.push(input.value);
    });
    
    // Guarda la nueva lista personalizada en el localStorage
    const key = `checklist_items_${currentAccountId}`;
    localStorage.setItem(key, JSON.stringify(newChecklistItems));
    
    // Sal del modo edición
    toggleChecklistEditMode();
    alert('¡Lista de tareas guardada!');
}

function addNewChecklistItem() {
    const input = document.getElementById('new-task-input');
    const newTaskText = input.value.trim();
    
    if (newTaskText) {
        const currentItems = getChecklistItemsForAccount();
        currentItems.push(newTaskText);
        
        // Guarda la lista actualizada temporalmente para que se muestre
        const key = `checklist_items_${currentAccountId}`;
        localStorage.setItem(key, JSON.stringify(currentItems));
        
        input.value = ''; // Limpia el campo
        showChecklist(true); // Refresca la vista en modo edición
    }
}

function removeChecklistItem(indexToRemove) {
    if (confirm('¿Seguro que quieres eliminar esta tarea de la lista?')) {
        let currentItems = getChecklistItemsForAccount();
        // Filtra el array para quitar el elemento en la posición 'indexToRemove'
        currentItems = currentItems.filter((_, index) => index !== indexToRemove);
        
        const key = `checklist_items_${currentAccountId}`;
        localStorage.setItem(key, JSON.stringify(currentItems));
        
        showChecklist(true); // Refresca la vista en modo edición
    }
}


        function markChecklistItem(index, checkbox) {
            const checklistKey = getChecklistKey();
            let estadoTareas = JSON.parse(localStorage.getItem(checklistKey)) || checklistItems.map(() => false);
            estadoTareas[index] = checkbox.checked;
            localStorage.setItem(checklistKey, JSON.stringify(estadoTareas));
            showChecklist();
        }

        function resetChecklist() {
            const checklistKey = getChecklistKey();
            localStorage.removeItem(checklistKey);
            showChecklist();
        }

        // --- Persistence and Accounts ---
        function getOperationsKey(accountId) {
            return `tradingOperations_${accountId}`;
        }

        function getSettingsKey(accountId) {
            return `tradingSettings_${accountId}`;
        }

        function getJournalsKey(accountId) {
            return `tradingJournals_${accountId}`;
        }

        function getGoalsKey(accountId) {
            return `tradingGoals_${accountId}`;
        }

        function loadAccounts() {
            try {
                const stored = localStorage.getItem(ACCOUNTS_KEY);
                accounts = stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Error loading accounts:", e);
                accounts = [];
            }
        }

        function saveAccounts() {
            try {
                localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(accounts));
            } catch (e) {
                console.error("Error saving accounts:", e);
            }
        }

        function populateAccountSelector() {
            const sel = document.getElementById('account-selector');
            sel.innerHTML = '';
            accounts.forEach(acc => {
                const opt = document.createElement('option');
                opt.value = acc.id;
                opt.textContent = acc.name;
                sel.appendChild(opt);
            });
            if (currentAccountId) {
                sel.value = currentAccountId;
            }
        }

        function setActiveAccount(id) {
            currentAccountId = id;
            localStorage.setItem(ACTIVE_ACCOUNT_KEY, currentAccountId);
            const settingsKey = getSettingsKey(currentAccountId);
            const storedSettings = localStorage.getItem(settingsKey);
            settings = storedSettings ? JSON.parse(storedSettings) : { initialBalance: 50000, consistencyPercentage: 40, trailingDrawdownAmount: 2500 };
            const opsKey = getOperationsKey(currentAccountId);
            const storedOperations = localStorage.getItem(opsKey);
            operations = storedOperations ? JSON.parse(storedOperations) : [];
            operations.sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00:00')));
            const journalsKey = getJournalsKey(currentAccountId);
            const storedJournals = localStorage.getItem(journalsKey);
            journals = storedJournals ? JSON.parse(storedJournals) : [];
            const goalsKey = getGoalsKey(currentAccountId);
            const storedGoals = localStorage.getItem(goalsKey);
            goals = storedGoals ? JSON.parse(storedGoals) : { weekly: 0, monthly: 0 };
            calculateHwmAndDrawdownFloor(true);
            populateAccountSelector();
            updateUI();
        }

        function openCreateAccountModal() {
            const name = prompt('Introduce nombre de la nueva cuenta:');
            if (!name) return;
            const id = Date.now().toString();
            accounts.push({ id: id, name: name });
            saveAccounts();
            setActiveAccount(id);
            alert('Cuenta creada. Ajusta la configuración de la cuenta si es necesario.');
            openSettingsModal();
        }

        function confirmDeleteAccount() {
            if (!currentAccountId) return;
            const currentAccount = accounts.find(a => a.id === currentAccountId);
            if (!currentAccount) return;
            if (accounts.length === 1) {
                alert('No puedes eliminar la única cuenta.');
                return;
            }
            if (confirm('¿Eliminar cuenta "' + currentAccount.name + '"? Esta acción eliminará todas sus operaciones, diarios y objetivos.')) {
                localStorage.removeItem(getOperationsKey(currentAccountId));
                localStorage.removeItem(getSettingsKey(currentAccountId));
                localStorage.removeItem(getJournalsKey(currentAccountId));
                localStorage.removeItem(getGoalsKey(currentAccountId));
                accounts = accounts.filter(a => a.id !== currentAccountId);
                saveAccounts();
                if (accounts.length > 0) {
                    setActiveAccount(accounts[0].id);
                } else {
                    const id = Date.now().toString();
                    accounts = [{ id: id, name: 'Cuenta 1' }];
                    saveAccounts();
                    setActiveAccount(id);
                }
                alert('Cuenta eliminada.');
            }
        }

        function saveData() {
            if (!currentAccountId) return;
            try {
                localStorage.setItem(getOperationsKey(currentAccountId), JSON.stringify(operations));
                localStorage.setItem(getSettingsKey(currentAccountId), JSON.stringify(settings));
                localStorage.setItem(getJournalsKey(currentAccountId), JSON.stringify(journals));
                localStorage.setItem(getGoalsKey(currentAccountId), JSON.stringify(goals));
                localStorage.setItem(ACTIVE_ACCOUNT_KEY, currentAccountId);
            } catch (e) {
                console.error("Error saving data:", e);
                alert("Error al guardar datos.");
            }
        }

        // --- Tabs ---
        function openTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            const tabs = document.querySelectorAll('.tab');
            tabContents.forEach(el => el.classList.remove('active'));
            tabs.forEach(el => el.classList.remove('active'));
            const tabElement = document.getElementById(tabName);
            const activeButton = document.querySelector(`.tab[onclick="openTab('${tabName}')"]`);
            if (tabElement) tabElement.classList.add('active');
            if (activeButton) activeButton.classList.add('active');
            if (tabName === 'Retos' && typeof app === 'undefined') { window.app = new RetosSemanales();}
            if (tabName === 'checklist') showChecklist();
            else if (tabName === 'historial') { populateYearFilter(); renderOperations(); }
            else if (tabName === 'dashboard') updateDashboard();
            else if (tabName === 'objetivos') {
                document.getElementById('journal-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('weekly-goal').value = goals.weekly || '';
                document.getElementById('monthly-goal').value = goals.monthly || '';
                updateJournalStatistics();
                showJournalEntries();
                updateGoalProgress();
            }
        }

        // --- Modals ---
        function openSettingsModal() {
            document.getElementById('initial-balance').value = settings.initialBalance;
            document.getElementById('consistency-percentage').value = settings.consistencyPercentage;
            document.getElementById('trailing-drawdown-amount').value = settings.trailingDrawdownAmount;
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function openDetailsModal() {
            document.getElementById('details-modal').style.display = 'flex';
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').style.display = 'none';
        }

        function saveSettings() {
            const ib = parseFloat(document.getElementById('initial-balance').value);
            const cp = parseInt(document.getElementById('consistency-percentage').value);
            const tda = parseFloat(document.getElementById('trailing-drawdown-amount').value);
            if (isNaN(ib) || ib < 0) { alert('Saldo inicial inválido.'); return; }
            if (isNaN(cp) || cp < 1 || cp > 100) { alert('% Consistencia inválido (1-100).'); return; }
            if (isNaN(tda) || tda <= 0) { alert('Importe Drawdown inválido (>0).'); return; }
            settings.initialBalance = ib;
            settings.consistencyPercentage = cp;
            settings.trailingDrawdownAmount = tda;
            calculateHwmAndDrawdownFloor(true);
            saveData();
            closeSettingsModal();
            updateUI();
            alert('Configuración guardada.');
        }

        function resetAllData() {
            if (confirm('¿Reiniciar TODAS las operaciones, diarios y objetivos? (Configuración se mantiene)')) {
                operations = [];
                journals = [];
                goals = { weekly: 0, monthly: 0 };
                highWaterMark = settings.initialBalance;
                drawdownFloor = settings.initialBalance - settings.trailingDrawdownAmount;
                localStorage.removeItem(getOperationsKey(currentAccountId));
                localStorage.removeItem(getJournalsKey(currentAccountId));
                localStorage.removeItem(getGoalsKey(currentAccountId));
                saveData();
                updateUI();
                alert('Datos reiniciados.');
            }
        }

        // --- Operations ---

      document.getElementById('trading-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const dateInput = document.getElementById('date');
    const typeInput = document.getElementById('type');
    const activoSelect = document.getElementById('activo');
    const customActivoInput = document.getElementById('custom-activo-input');
    const estrategiaSelect = document.getElementById('estrategia');
    const customEstrategiaInput = document.getElementById('custom-estrategia-input');
    const contractsInput = document.getElementById('contracts');
    const entryTimeInput = document.getElementById('entry-time');
    const exitTimeInput = document.getElementById('exit-time');
    const amountInput = document.getElementById('amount');
    const entryTypeSelect = document.getElementById('entry-type');
    const customEntryTypeInput = document.getElementById('custom-entry-type-input');
    const exitTypeSelect = document.getElementById('exit-type');
    const customExitTypeInput = document.getElementById('custom-exit-type-input');
    const mediaInput = document.getElementById('trade-media');
    const notesInput = document.getElementById('notes');
    const moodInput = document.getElementById('journal-mood');
    const newsRatingInput = document.getElementById('journal-news');

    const date = dateInput.value;
    const type = typeInput.value || null;
    
    // Obtener activo (personalizado o seleccionado)
    let activo = activoSelect.value;
    if (activo === 'custom') {
        activo = customActivoInput.value.trim();
    }
    
    // Obtener estrategia (personalizada o seleccionada)
    let estrategia = estrategiaSelect.value;
    if (estrategia === 'custom') {
        estrategia = customEstrategiaInput.value.trim();
    }
    
    const contracts = parseInt(contractsInput.value) || null;
    
    // Obtener tipo de entrada (personalizado o seleccionado)
    let entryType = entryTypeSelect.value;
    if (entryType === 'custom') {
        entryType = customEntryTypeInput.value.trim();
    }
    
    // Obtener tipo de salida (personalizado o seleccionado)
    let exitType = exitTypeSelect.value;
    if (exitType === 'custom') {
        exitType = customExitTypeInput.value.trim();
    }
    
    const entryTime = entryTimeInput.value || null;
    const exitTime = exitTimeInput.value || null;
    const amount = parseAmount(amountInput.value);
    const notes = notesInput.value.trim();
    const mood = moodInput.value.trim();
    const newsRating = parseInt(newsRatingInput.value) || 0;

    if (!date || isNaN(amount)) {
        alert('Introduce Fecha e Importe válidos (Ej: 150.50 o -75.20).');
        if (!date) dateInput.focus(); else amountInput.focus();
        return;
    }
    if (entryTime && !/^\d{2}:\d{2}(:\d{2})?$/.test(entryTime)) { alert('Formato hora entrada inválido.'); return; }
    if (exitTime && !/^\d{2}:\d{2}(:\d{2})?$/.test(exitTime)) { alert('Formato hora salida inválido.'); return; }

    readFileAsDataURL(mediaInput.files[0], (mediaData) => {
        const operation = {
            id: Date.now(),
            date,
            type,
            activo: activo || 'N/A',
            estrategia: estrategia || 'N/A',
            contracts: contracts,
            entryType: entryType || null,
            exitType: exitType || null,
            entryTime,
            exitTime,
            duration: calculateDuration(entryTime, exitTime),
            amount,
            notes,
            mood,
            newsRating,
            media: mediaData
        };
        operations.push(operation);
        operations.sort((a, b) => new Date(a.date + 'T' + (a.entryTime || '00:00:00')) - new Date(b.date + 'T' + (b.entryTime || '00:00:00')));
        calculateHwmAndDrawdownFloor();
        saveData();
        alert('Operación guardada.');
        
        // Reset form
        document.getElementById('trading-form').reset();
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        document.getElementById('custom-activo-input').style.display = 'none';
        document.getElementById('custom-estrategia-input').style.display = 'none';
        document.getElementById('custom-entry-type-input').style.display = 'none';
        document.getElementById('custom-exit-type-input').style.display = 'none';
        setNewsRating(0);
        
        updateUI();
    });
});

function deleteOperation(id) {
            if (confirm('¿Eliminar esta operación?')) {
                operations = operations.filter(op => op.id !== id);
                calculateHwmAndDrawdownFloor();
                saveData();
                updateUI();
                alert('Operación eliminada.');
            }
        }
        
          function setMood(mood) {
    document.getElementById('journal-mood').value = mood;
}
         // --- Asset Selection ---
       function handleAssetSelection(selectElement) {
    const selectedValue = selectElement.value;
    let customInputId;

    if (selectElement.id === 'activo') {
        customInputId = 'custom-activo-input';
    } else if (selectElement.id === 'estrategia') {
        customInputId = 'custom-estrategia-input';
    } else if (selectElement.id === 'entry-type') {
        customInputId = 'custom-entry-type-input';
    } else if (selectElement.id === 'exit-type') {
        customInputId = 'custom-exit-type-input';
    }

    const customInput = document.getElementById(customInputId);

    if (selectedValue === 'custom') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
}


        // --- Drawdown Logic ---
  function calculateHwmAndDrawdownFloor(fullRecalculate = false) {
            let currentBalance = settings.initialBalance;
            let peakBalance = settings.initialBalance;
            let calculatedFloor = settings.initialBalance - settings.trailingDrawdownAmount;
            const bufferThreshold = settings.initialBalance + settings.trailingDrawdownAmount;
            let floorIsFixed = false;

            let historicalPeak = settings.initialBalance;
            for (const op of operations) {
                historicalPeak += op.amount;
                if (historicalPeak >= bufferThreshold) {
                    floorIsFixed = true;
                    break;
                }
            }

            if (floorIsFixed) {
                calculatedFloor = settings.initialBalance;
            } else {
                currentBalance = settings.initialBalance;
                peakBalance = settings.initialBalance;
                operations.forEach(op => {
                    currentBalance += op.amount;
                    if (currentBalance > peakBalance) {
                        peakBalance = currentBalance;
                    }
                });
                calculatedFloor = peakBalance - settings.trailingDrawdownAmount;
            }

            let runningBalance = settings.initialBalance;
            highWaterMark = settings.initialBalance;
            operations.forEach(op => {
                runningBalance += op.amount;
                highWaterMark = Math.max(highWaterMark, runningBalance);
            });

            drawdownFloor = Math.max(calculatedFloor, settings.initialBalance - settings.trailingDrawdownAmount);
            if (floorIsFixed) {
                drawdownFloor = Math.min(drawdownFloor, settings.initialBalance);
            }
        }

        // --- Journals ---
function setNewsRating(value) {
            const stars = document.querySelectorAll('.star');
            stars.forEach(star => {
                star.classList.remove('selected');
                if (parseInt(star.dataset.value) <= value) {
                    star.classList.add('selected');
                }
            });
            document.getElementById('journal-news').value = value;
        }

function showJournalEntries() {
    const entriesContainer = document.getElementById('journal-entries');
    entriesContainer.innerHTML = '';

    // Filtramos para obtener SOLO las metas que NO están conseguidas.
    const activeJournals = journals.filter(entry => !entry.achieved);

    if (activeJournals.length === 0) {
        entriesContainer.innerHTML = '<p>¡No tienes metas pendientes! Buen trabajo.</p>';
        return;
    }

    // Ordenamos por fecha
    activeJournals.sort((a, b) => new Date(b.date) - new Date(a.date));

    activeJournals.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'entry';
        
        div.innerHTML = `
            <div class="entry-header">
                <input type="checkbox" onchange="toggleGoalAchieved(${entry.id}, this.checked)" title="Marcar como conseguida">
                <span>${entry.title}</span>
                <button class="delete-entry" onclick="deleteJournalEntry(${entry.id})">✕</button>
            </div>
            <p style="font-size: 0.8em; color: #b3b3b3; margin-top: 5px;">Fecha: ${formatDate(entry.date)}</p>
        `;
        entriesContainer.appendChild(div);
    });
}

 function saveJournalEntry() {
            const date = document.getElementById('journal-date').value;
            const title = document.getElementById('journal-title').value.trim();
            
            if (!date || !title) {
                alert('Por favor, completa la fecha y el título de la meta.');
                return;
            }

            // Creamos un objeto simple para la meta
            const entry = {
                id: Date.now(),
                date: date,
                title: title,
                achieved: false // Nuevo estado para saber si se ha conseguido
            };

            journals.push(entry); // 'journals' ahora almacenará nuestras metas
            saveData(); // Guardamos los datos en el LocalStorage

            // Limpiamos los campos del formulario
            document.getElementById('journal-title').value = '';
            
            // Actualizamos la interfaz de usuario para mostrar la nueva meta
            updateUI();
            alert('Meta guardada correctamente.');
        }

function deleteJournalEntry(id) {
            if (confirm('¿Eliminar esta entrada?')) {
                journals = journals.filter(entry => entry.id !== id);
                saveData();
                showJournalEntries();
            }
        }
function renderAchievedGoals() {
    const container = document.getElementById('historial-metas-conseguidas');
    container.innerHTML = '';

    // Filtramos para obtener SOLO las metas que SÍ están conseguidas.
    const achievedJournals = journals.filter(entry => entry.achieved);

    if (achievedJournals.length === 0) {
        container.innerHTML = '<p>Aún no has completado ninguna meta.</p>';
        return;
    }

    // Ordenamos por fecha
    achievedJournals.sort((a, b) => new Date(b.date) - new Date(a.date));

    achievedJournals.forEach(entry => {
        const div = document.createElement('div');
        div.className = 'entry completed'; // Clase para estilo
        
        // --- ¡AQUÍ ESTÁ EL CAMBIO CLAVE! ---
        // Hemos reemplazado el <input type="checkbox"> por un icono de check visual.
        // Este icono no es interactivo, por lo que no puedes desmarcarlo.
        div.innerHTML = `
            <div class="entry-header">
                <span style="font-size: 20px; color: #10b9b9; margin-right: 10px;">✔</span>
                <span style="text-decoration: line-through; color: #6b7280;">${entry.title}</span>
                <button class="delete-entry" onclick="deleteJournalEntry(${entry.id})">✕</button>
            </div>
            <p style="font-size: 0.8em; color: #b3b3b3; margin-top: 5px;">Conseguida: ${formatDate(entry.date)}</p>
        `;
        container.appendChild(div);
    });
}

 function saveGoals() {
            const weeklyGoal = parseFloat(document.getElementById('weekly-goal').value) || 0;
            const monthlyGoal = parseFloat(document.getElementById('monthly-goal').value) || 0;
            if (weeklyGoal < 0 || monthlyGoal < 0) {
                alert('Los objetivos deben ser valores positivos.');
                return;
            }
            goals.weekly = weeklyGoal;
            goals.monthly = monthlyGoal;
            saveData();
            updateUI();
            alert('Objetivos guardados.');
        }

 function updateJournalStatistics() {
            const cont = document.getElementById('journal-stats-container');
            cont.innerHTML = '';
            if (operations.length === 0) {
                cont.innerHTML = '<p>No hay operaciones.</p>';
                return;
            }
            const tOps = operations.length;
            const wOps = operations.filter(op => op.amount > 0);
            const lOps = operations.filter(op => op.amount < 0);
            const nOps = operations.filter(op => op.amount === 0);
            const tWins = wOps.length;
            const tLosses = lOps.length;
            const tProfit = wOps.reduce((s, op) => s + op.amount, 0);
            const tLoss = lOps.reduce((s, op) => s + op.amount, 0);
            const netP = tProfit + tLoss;
            const winR = (tWins + tLosses) > 0 ? (tWins / (tWins + tLosses) * 100) : 0;
            const avgW = tWins > 0 ? tProfit / tWins : 0;
            const avgL = tLosses > 0 ? tLoss / tLosses : 0;
            const pF = (tLoss !== 0) ? Math.abs(tProfit / tLoss) : (tProfit > 0 ? Infinity : 0);
            let tDurS = 0, vDurCnt = 0;
            operations.forEach(op => {
                const dur = calculateDuration(op.entryTime, op.exitTime);
                if (typeof dur === 'string' && dur.includes('h')) {
                    const p = dur.match(/(\d+)h (\d+)m (\d+)s/);
                    if (p) {
                        tDurS += parseInt(p[1]) * 3600 + parseInt(p[2]) * 60 + parseInt(p[3]);
                        vDurCnt++;
                    }
                }
            });
            const avgDurS = vDurCnt > 0 ? tDurS / vDurCnt : 0;
            const avgH = Math.floor(avgDurS / 3600), avgM = Math.floor((avgDurS % 3600) / 60), avgS = Math.floor(avgDurS % 60);
            const avgDurFmt = vDurCnt > 0 ? `${avgH}h ${avgM}m ${avgS}s` : 'N/A';
            cont.innerHTML = `
                <h3>Estadísticas Generales</h3>
                <div class="card-stats">
                    <div class="stat-box"><h4>Total Ops</h4><p>${tOps}</p></div>
                    <div class="stat-box"><h4>Ganadoras</h4><p class="positive">${tWins}</p></div>
                    <div class="stat-box"><h4>Perdedoras</h4><p class="negative">${tLosses}</p></div>
                    <div class="stat-box"><h4>Ratio Acierto</h4><p class="${winR >= 50 ? 'positive' : 'negative'}">${(tWins + tLosses) > 0 ? formatPercentage(winR) : 'N/A'}</p></div>
                    <div class="stat-box"><h4>Beneficio Bruto</h4><p class="positive">${formatCurrency(tProfit)}</p></div>
                    <div class="stat-box"><h4>Pérdida Bruta</h4><p class="${getPercentageClass(winR)}">${(tWins + tLosses) > 0 ? formatPercentage(winR) : 'N/A'}</p></div>
                    <div class="stat-box"><h4>Beneficio Neto</h4><p class="${netP >= 0 ? 'positive' : 'negative'}">${formatCurrency(netP)}</p></div>
                    <div class="stat-box"><h4>Ganancia Media</h4><p class="positive">${formatCurrency(avgW)}</p></div>
                    <div class="stat-box"><h4>Pérdida Media</h4><p class="negative">${formatCurrency(Math.abs(avgL))}</p></div>
                    <div class="stat-box"><h4>Profit Factor</h4><p class="${pF >= 1 ? 'positive' : 'negative'}">${pF === Infinity ? '∞' : pF.toFixed(2)}</p></div>
                    <div class="stat-box"><h4>Duración Media</h4><p>${avgDurFmt}</p></div>
                    ${nOps.length > 0 ? `<div class="stat-box"><h4>Neutras</h4><p>${nOps.length}</p></div>` : ''}
                </div>
            `;
        }
function toggleGoalAchieved(id, isAchieved) {
            const entry = journals.find(e => e.id === id);
            if (entry) {
                entry.achieved = isAchieved;
                saveData(); // Guardamos el cambio
                updateUI(); // Actualizamos la vista para que se vea el tachado
            }
        }
        // --- UI Updates ---
function updateUI() {
    // 1. Actualiza los números del Dashboard (saldo, P/L, etc.)
    updateDashboard(); 
      // 2. Dibuja el gráfico de crecimiento de capital.
    //    Esta es la línea clave que soluciona el problema.
    renderCapitalGrowthChart();

    //    Al sacar esta línea del 'if', nos aseguramos de que el Dashboard
    //    se refresque sin importar en qué pestaña estemos.
    showJournalEntries(); 

    // 3. Ahora, maneja las actualizaciones específicas de cada pestaña.
    if (document.getElementById('checklist').classList.contains('active')) {
        showChecklist();
    }
    if (document.getElementById('historial').classList.contains('active')) {
        populateYearFilter(); 
        renderOperations(); // Esta ya se encarga de las metas conseguidas en el historial
    }
    if (document.getElementById('objetivos').classList.contains('active')) {
        document.getElementById('journal-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('weekly-goal').value = goals.weekly || '';
        document.getElementById('monthly-goal').value = goals.monthly || '';
        updateJournalStatistics();
        updateGoalProgress();
        renderCapitalGrowthChart();
        
    }
}


 function populateYearFilter() {
            const sel = document.getElementById('filter-year');
            const cur = sel.value;
            const years = new Set(operations.map(op => op.date.substring(0, 4)));
            years.add(new Date().getFullYear().toString());
            const sorted = Array.from(years).sort((a, b) => b - a);
            while (sel.options.length > 1) sel.remove(1);
            sorted.forEach(y => {
                const o = document.createElement('option');
                o.value = y;
                o.textContent = y;
                sel.appendChild(o);
            });
            sel.value = sorted.includes(cur) ? cur : '';
        }
  // --- Atencion---
      function renderOperations(filteredOps = null) {
    const list = document.getElementById('operations-list');
    list.innerHTML = '';
    const ops = filteredOps || operations;
    
    if (ops.length === 0) {
        list.innerHTML = '<tr><td colspan="9" style="text-align: center;">No hay operaciones para mostrar.</td></tr>';
        renderAchievedGoals(); 
        return;
    }
    
    // Ordenar operaciones
    const sortedOps = ops.sort((a, b) => {
        const dateA = new Date(a.date + 'T' + (a.entryTime || '00:00:00'));
        const dateB = new Date(b.date + 'T' + (b.entryTime || '00:00:00'));
        return dateB - dateA || b.id - a.id;
    });

    // Decidir cuántas operaciones mostrar
    const displayLimit = parseInt(document.getElementById('operations-display').value);
    const opsToShow = displayLimit === -1 ? sortedOps : sortedOps.slice(0, displayLimit);

    // Renderizar operaciones
    opsToShow.forEach(op => {
        const tr = document.createElement('tr');
        tr.className = op.type === 'bullish' ? 'operation-bullish' : (op.type === 'bearish' ? 'operation-bearish' : '');
        
        const mediaHtml = op.media ? 
            (op.media.startsWith('data:image') ? 
                `<img src="${op.media}" class="media-preview">` :
                `<video src="${op.media}" class="media-preview" controls></video>`) : 'N/A';
        
        // Formatear el mood para que solo muestre el icono
        let moodDisplay = op.mood || 'N/A';
        if (moodDisplay.includes('😊')) moodDisplay = '😊';
        else if (moodDisplay.includes('😐')) moodDisplay = '😐';
        else if (moodDisplay.includes('😟')) moodDisplay = '😟';
        else if (moodDisplay.includes('😠')) moodDisplay = '😠';
        
        tr.innerHTML = `
            <td>${formatDate(op.date)}</td>
            <td>${formatType(op.type)}</td>
            <td>${op.activo || 'N/A'}</td>
            <td>${op.estrategia || 'N/A'}</td>
            <td>${op.contracts || 'N/A'}</td>
            <td>${op.entryType || 'N/A'}</td>
            <td>${op.exitType || 'N/A'}</td>
            <td>${op.duration}</td>
            <td>${moodDisplay}</td>
            <td class="${op.amount > 0 ? 'positive' : (op.amount < 0 ? 'negative' : '')}">${formatCurrency(op.amount)}</td>
            <td>${mediaHtml}</td>
            <td>
                <button onclick="showOperationDetails(${op.id})" 
                class="button-secondary button-small" style="margin-right: 5px;">Ver</button>
                <button onclick="deleteOperation(${op.id})" class="button-danger button-small">Eliminar</button>
            </td>
        `;
        list.appendChild(tr);
    });

    // Renderizar metas conseguidas
    renderAchievedGoals();
}  
function changeOperationsDisplay() {
    filterOperations(); // Esto llamará a renderOperations con la nueva configuración
}
  // --- 
   function showOperationDetails(id) {
    const op = operations.find(op => op.id === id);
    if (!op) return;
    
    const mediaHtml = op.media ? 
        (op.media.startsWith('data:image') ? 
            `<img src="${op.media}" style="max-width: 100%; border-radius: 5px; margin-top: 10px;">` :
            `<video src="${op.media}" style="max-width: 100%; border-radius: 5px; margin-top: 10px;" controls></video>`) 
        : '<p><em>Sin media</em></p>';
    
    // Formatear valoración de noticias como estrellas
    const starsHtml = '★'.repeat(op.newsRating || 0) + '☆'.repeat(4 - (op.newsRating || 0));
    
    document.getElementById('operation-details-content').innerHTML = `
        <div style="margin-bottom: 15px;">
            <p><strong>Fecha:</strong> ${formatDate(op.date)}</p>
            <p><strong>Tipo:</strong> ${formatType(op.type)}</p>
            <p><strong>Activo:</strong> ${op.activo || 'N/A'}</p>
            <p><strong>Estrategia:</strong> ${op.estrategia || 'N/A'}</p>
            <p><strong>Contratos:</strong> ${op.contracts || 'N/A'}</p>
            <p><strong>Tipo de Entrada:</strong> ${op.entryType || 'N/A'}</p>
            <p><strong>Tipo de Salida:</strong> ${op.exitType || 'N/A'}</p>
            <p><strong>Hora Entrada:</strong> ${op.entryTime || 'N/A'}</p>
            <p><strong>Hora Salida:</strong> ${op.exitTime || 'N/A'}</p>
            <p><strong>Duración:</strong> ${op.duration}</p>
            <p><strong>Importe:</strong> <span class="${op.amount > 0 ? 'positive' : (op.amount < 0 ? 'negative' : '')}">${formatCurrency(op.amount)}</span></p>
            <p><strong>Estado de Ánimo:</strong> ${op.mood || 'N/A'}</p>
            <p><strong>Valoración Noticias:</strong> ${starsHtml}</p>
        </div>
        ${op.notes ? `<div style="border-top: 1px solid #4b5563; padding-top: 15px;"><h4>Notas:</h4><p style="white-space: pre-wrap;">${op.notes}</p>
            </div>` : '<p><em>Sin notas.</em></p>'}
        <div style="border-top: 1px solid #4b5563; padding-top: 15px;"><h4>Media:</h4>${mediaHtml}</div>
    `;
    openDetailsModal();
}
        // --- operacion diario

        function filterOperations() {
            const yf = document.getElementById('filter-year').value;
            const mf = document.getElementById('filter-month').value;
            const tf = document.getElementById('filter-type').value;
            const rf = document.getElementById('filter-result').value;
            let fOps = [...operations];
            if (yf) fOps = fOps.filter(op => op.date.substring(0, 4) === yf);
            if (mf) fOps = fOps.filter(op => op.date.substring(5, 7) === mf);
            if (tf) fOps = fOps.filter(op => tf === 'none' ? !op.type : op.type === tf);
            if (rf) fOps = fOps.filter(op => rf === 'win' ? op.amount > 0 : (rf === 'loss' ?
             op.amount < 0 : op.amount === 0));
            renderOperations(fOps);
        }

        function updateGoalProgress() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth() + 1;
            const weekNumber = getWeekNumber(today);

            const weeklyOps = operations.filter(op => {
                const opDate = new Date(op.date);
                return getWeekNumber(opDate) === weekNumber && opDate.getFullYear() === year;
            });
            const monthlyOps = operations.filter(op => {
                const opDate = new Date(op.date);
                return opDate.getFullYear() === year && (opDate.getMonth() + 1) === month;
            });

            const weeklyPL = weeklyOps.reduce((sum, op) => sum + op.amount, 0);
            const monthlyPL = monthlyOps.reduce((sum, op) => sum + op.amount, 0);

            const weeklyPerc = goals.weekly > 0 ? (weeklyPL / goals.weekly * 100) : 0;
            const monthlyPerc = goals.monthly > 0 ? (monthlyPL / goals.monthly * 100) : 0;

            // Update dashboard
            const weeklyPercElem = document.getElementById('weekly-progress-percentage');
            const monthlyPercElem = document.getElementById('monthly-progress-percentage');
            if (weeklyPercElem) {
            weeklyPercElem.textContent = formatPercentage(weeklyPerc);
             weeklyPercElem.className = getPercentageClass(weeklyPerc);
             }
           if (monthlyPercElem) {
           monthlyPercElem.textContent = formatPercentage(monthlyPerc);
           monthlyPercElem.className = getPercentageClass(monthlyPerc);
             }


            // Update objetivos
            const weeklyDetElem = document.getElementById('weekly-progress-detailed');
            const monthlyDetElem = document.getElementById('monthly-progress-detailed');
            if (weeklyDetElem) weeklyDetElem.textContent = `Progreso: ${formatCurrency(weeklyPL)} / ${formatCurrency(goals.weekly)} 
            (${formatPercentage(weeklyPerc)})`;
            if (monthlyDetElem) monthlyDetElem.textContent = `Progreso: ${formatCurrency(monthlyPL)} / ${formatCurrency(goals.monthly)} 
            (${formatPercentage(monthlyPerc)})`;
        }

        // --- Dashboard Updates ---
        function updateDashboard() {
            if (!currentAccountId) return;

            const initialBalance = settings.initialBalance;
            const totalPL = operations.reduce((sum, op) => sum + op.amount, 0);
            const currentBalance = initialBalance + totalPL;
            const roi = initialBalance > 0 ? (totalPL / initialBalance * 100) : 0;

            document.getElementById('initial-balance-display').textContent = formatCurrency(initialBalance);
            document.getElementById('current-balance').textContent = formatCurrency(currentBalance);
            const plElem = document.getElementById('profit-loss');
            plElem.textContent = formatCurrency(totalPL);
            plElem.className = totalPL > 0 ? 'positive' : (totalPL < 0 ? 'negative' : '');
            const roiElem = document.getElementById('roi');
            roiElem.textContent = formatPercentage(roi);
            roiElem.className = roi > 0 ? 'positive' : (roi < 0 ? 'negative' : '');

            document.getElementById('high-water-mark').textContent = formatCurrency(highWaterMark);
            document.getElementById('drawdown-floor').textContent = formatCurrency(drawdownFloor);
            const marginToFloor = currentBalance - drawdownFloor;
            const marginElem = document.getElementById('margin-to-floor');
            marginElem.textContent = formatCurrency(marginToFloor);
            marginElem.className = marginToFloor > 0 ? 'positive' : 'negative';

            const explanationElem = document.getElementById('drawdown-explanation');
            if (currentBalance < drawdownFloor) {
                explanationElem.innerHTML += '<p class="drawdown-floor-warning">¡Advertencia: Saldo por debajo del suelo de drawdown!</p>';
            }

            document.getElementById('consistency-limit-display').textContent = settings.consistencyPercentage;
            updateConsistencyRule();

            document.getElementById('weekly-goal-display').textContent = formatCurrency(goals.weekly);
            document.getElementById('monthly-goal-display').textContent = formatCurrency(goals.monthly);
            updateGoalProgress();

            updateWeeklyPerformance();
            renderWeeklySuccessRate();
            updateRecentOperations();
        }

        function updateConsistencyRule() {
            const dailyProfits = {};
            operations.forEach(op => {
                if (!dailyProfits[op.date]) dailyProfits[op.date] = 0;
                dailyProfits[op.date] += op.amount;
            });

            const positiveDays = Object.values(dailyProfits).filter(p => p > 0);
            if (positiveDays.length === 0) {
                document.getElementById('consistency-details').textContent = 'No hay suficientes datos para calcular la consistencia.';
                document.getElementById('consistency-progress').style.width = '0%';
                return;
            }

            const maxDay = Math.max(...positiveDays);
            const totalPositive = positiveDays.reduce((s, p) => s + p, 0);
            const percentage = (maxDay / totalPositive * 100);
            const progress = Math.min(percentage / settings.consistencyPercentage * 100, 100);

            const bar = document.getElementById('consistency-progress');
            bar.style.width = `${progress}%`;
            bar.className = 'progress-bar';
            if (percentage > settings.consistencyPercentage) bar.classList.add('danger');
            else if (percentage > settings.consistencyPercentage * 0.8) bar.classList.add('warning');

            const progressLabel = document.querySelector('.progress-label');
             progressLabel.textContent = formatPercentage(percentage);
             progressLabel.className = `progress-label ${getPercentageClass(percentage)}`;
            document.getElementById('consistency-details').textContent = `Día más rentable: ${formatCurrency(maxDay)}
             (${formatPercentage(percentage)}) de total ganancias ${formatCurrency(totalPositive)}`;
        }

        function updateWeeklyPerformance() {
            const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
            const performance = Array(5).fill(0);
            operations.forEach(op => {
                let day = new Date(op.date).getDay();
                if (day === 0) day = 5; // Domingo a final
                else day -= 1;
                performance[day] += op.amount;
            });

            const container = document.getElementById('weekly-performance');
            container.innerHTML = '';
            days.forEach((day, index) => {
                const box = document.createElement('div');
                box.className = 'stat-box';
                box.innerHTML = `<h4>${day}</h4><p class="${performance[index] > 0 ? 'positive' : (performance[index] < 0 ? 'negative' : '')}">${formatCurrency(performance[index])}</p>`;
                container.appendChild(box);
            });
        }
    function renderWeeklySuccessRate() {
    const weeklySuccessRate = document.getElementById('weekly-success-rate');
    if (!weeklySuccessRate) return;

    // Definir solo los días hábiles
    const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
    const dayStats = {};

    // Inicializar estadísticas solo para días hábiles
    days.forEach(day => {
        dayStats[day] = { total: 0, wins: 0, percentage: 0 };
    });

    // Calcular estadísticas por día
    operations.forEach(op => {
        const dayName = getDayOfWeek(op.date);
        // Solo procesar si el día es hábil
        if (days.includes(dayName)) {
            const amount = parseFloat(op.amount) || 0;
            dayStats[dayName].total++;
            if (amount > 0) {
                dayStats[dayName].wins++;
            }
        }
    });

    // Calcular porcentajes
    Object.keys(dayStats).forEach(day => {
        if (dayStats[day].total > 0) {
            dayStats[day].percentage = (dayStats[day].wins / dayStats[day].total * 100).toFixed(1);
        }
    });

    // Renderizar
    weeklySuccessRate.innerHTML = days.map(day => {
        const stats = dayStats[day];
        const percentage = stats.percentage;
        const colorClass = percentage >= 60 ? 'positive' : percentage >= 40 ? 'warning' : 'negative';

        return `
            <div class="stat-box">
                <h4>${day}</h4>
                <p class="${colorClass}">${percentage}%</p>
                <small>${stats.wins}/${stats.total} aciertos</small>
            </div>
        `;
    }).join('');
}


        function updateRecentOperations() {
            const recent = operations.slice(-5).reverse();
            const container = document.getElementById('recent-operations');
            container.innerHTML = '';
            if (recent.length === 0) {
                container.innerHTML = '<p>No hay operaciones recientes para mostrar.</p>';
                return;
            }
            const table = document.createElement('table');
            table.innerHTML = '<thead><tr><th>Fecha</th><th>Importe</th></tr></thead><tbody></tbody>';
            recent.forEach(op => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${formatDate(op.date)}</td><td class="${op.amount > 0 ? 'positive' : (op.amount < 0 ? 'negative' : '')}">${formatCurrency(op.amount)}</td>`;
                table.querySelector('tbody').appendChild(tr);
            });
            container.appendChild(table);
        }
        function getPercentageClass(percentage) {
    if (percentage === 50 || percentage === 0) {
        return 'percentage-50'; // Blanco
    } else if (percentage < 50) {
        return 'percentage-below-50'; // Rosa fucsia
    } else {
        return 'percentage-above-50'; // Turquesa
    }
  }
// --- VERSIÓN DE DEPURACIÓN de renderCapitalGrowthChart ---


        // --- Inicialización ---
        loadAccounts();
        const storedActive = localStorage.getItem(ACTIVE_ACCOUNT_KEY);
        if (storedActive && accounts.find(a => a.id === storedActive)) {
            setActiveAccount(storedActive);
        } else if (accounts.length === 0) {
            openCreateAccountModal();
        } else {
            setActiveAccount(accounts[0].id);
        }
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        openTab('dashboard');
        
// Registro del Service Worker
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
            .then((registration) => {
                console.log('SW registrado correctamente');
            })
            .catch((error) => {
                console.log('Error registrando SW:', error);
            });
    });
}
function renderCapitalGrowthChart() {
    const canvas = document.getElementById('capitalGrowthChart');
    if (!canvas) {
        console.error("Canvas 'capitalGrowthChart' no encontrado.");
        return;
    }

    if (window.capitalGrowthChartInstance) {
        window.capitalGrowthChartInstance.destroy();
    }

    // --- 1. Agrupar Operaciones por Día ---
    const dailyBalances = {};
    let runningBalance = settings.initialBalance;
    let highWaterMark = settings.initialBalance;

    const sortedOperations = [...operations].sort((a, b) => new Date(a.date) - new Date(b.date));

    sortedOperations.forEach(op => {
        runningBalance += op.amount;
        dailyBalances[op.date] = runningBalance;
        highWaterMark = Math.max(highWaterMark, runningBalance);
    });

    // --- 2. Preparar los Datos para el Gráfico ---
    const labels = [];
    const balanceData = [];
    const drawdownData = [];

    if (sortedOperations.length > 0) {
        const firstOpDate = new Date(sortedOperations[0].date);
        firstOpDate.setDate(firstOpDate.getDate() - 1); // Un día antes para el "bajón" inicial
        
        labels.push(firstOpDate.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }));
        balanceData.push(settings.initialBalance);
        drawdownData.push(settings.initialBalance - settings.trailingDrawdownAmount); // Drawdown inicial
    }

    let currentHWM = settings.initialBalance;
    for (const date in dailyBalances) {
        labels.push(new Date(date).toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }));
        balanceData.push(dailyBalances[date]);
        currentHWM = Math.max(currentHWM, dailyBalances[date]); // Actualizamos HWM hasta este punto
        // Calculamos el drawdown basado en el HWM actual, con lógica de buffer
        let drawdownValue = currentHWM - settings.trailingDrawdownAmount;
        if (currentHWM >= settings.initialBalance + settings.trailingDrawdownAmount) {
            drawdownValue = settings.initialBalance; // Fijamos si supera el buffer
        } else {
            drawdownValue = Math.max(drawdownValue, settings.initialBalance - settings.trailingDrawdownAmount); // Mínimo permitido
        }
        drawdownData.push(drawdownValue);
    }

    // --- 3. Creación del Gráfico Estilo Bulenox ---
    window.capitalGrowthChartInstance = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Balance',
                    data: balanceData,
                    borderColor: '#00f2ea',
                    backgroundColor: 'rgba(0, 242, 234, 0.1)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 5, // Aumentado de 2 a 5 para puntos más grandes
                },
                {
                    label: 'Suelo Drawdown',
                    data: drawdownData,
                    borderColor: '#ef44bc',
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 5, // Cambiado de 0 a 5 para mostrar puntos grandes
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: false,
            scales: {
                x: {
                    ticks: { color: '#b3b3b3', maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 8 },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: '#b3b3b3', callback: (v) => v.toLocaleString('es-ES', { style: 'currency', currency: 'EUR' }) },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            plugins: {
                legend: { 
                    display: true,
                    position: 'top',
                    align: 'start',
                    labels: {
                        color: '#ffffff',
                        boxWidth: 20,
                        padding: 20
                    }
                }
            }
        }
    });
}

class RetosSemanales {
    constructor() {
        this.currentWeek = this.getCurrentWeekKey();
        this.currentMonth = new Date().getMonth();
        this.currentYear = new Date().getFullYear();
        this.data = this.loadData();
        this.dias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
        this.chartInstance = null;
        this.monthlyChartInstance = null;
        this.viendoTodo = false;
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.renderAll();
    }

    setupEventListeners() {
        document.getElementById('prevWeek').addEventListener('click', () => this.changeWeek(-1));
        document.getElementById('nextWeek').addEventListener('click', () => this.changeWeek(1));
        document.getElementById('retoInput').addEventListener('input', (e) => this.updateReto(e.target.value));
        document.getElementById('retoInput').addEventListener('blur', () => this.fixReto());
        document.getElementById('btnGuardarHistorial').addEventListener('click', () => this.guardarEnHistorial());
        document.getElementById('btnBorrarHistorial').addEventListener('click', () => this.borrarHistorial());
        document.getElementById('btnEditarReto').addEventListener('click', () => this.editarReto());
        document.getElementById('btnGuardarReto').addEventListener('click', () => this.guardarReto());
        document.getElementById('prevMonthBtn').addEventListener('click', () => this.changeMonth(-1));
        document.getElementById('nextMonthBtn').addEventListener('click', () => this.changeMonth(1));
        document.getElementById('toggleTotalViewBtn').addEventListener('click', () => this.toggleVistaTotal());
    }

    loadData() {
        const saved = localStorage.getItem('retosSemanalesData');
        return saved ? JSON.parse(saved) : {};
    }

    saveData() {
        localStorage.setItem('retosSemanalesData', JSON.stringify(this.data));
    }

    getCurrentWeekData() {
        if (!this.data[this.currentWeek]) {
            this.data[this.currentWeek] = {
                reto: '',
                retoFijo: false,
                completada: false,
                dias: {}
            };
            this.dias.forEach(dia => {
                this.data[this.currentWeek].dias[dia.toLowerCase()] = { cumplido: null, resultado: null };
            });
        }
        return this.data[this.currentWeek];
    }

toggleVistaTotal() {
    // Invierte el estado actual (si es true, se vuelve false, y viceversa)
    this.viendoTodo = !this.viendoTodo;
    // Vuelve a renderizar las estadísticas con el nuevo estado
    this.renderMonthlyStats();
}

    renderAll() {
        this.renderWeekDisplay();
        this.renderDias();
        this.renderEstadisticas();
        this.renderMonthlyStats();
        this.renderHistorial();
        this.loadCurrentWeekData();
    }

    renderWeekDisplay() {
        document.getElementById('currentWeekDisplay').textContent = this.formatWeekName(this.currentWeek);
    }

    renderDias() {
        const container = document.getElementById('diasGrid');
        container.innerHTML = `<div class="dias-grid-header"><span>Día</span><span>Reto</span><span>Operativa</span></div>`;
        const weekData = this.getCurrentWeekData();
        const isCompletada = weekData.completada;

        this.dias.forEach(dia => {
            const diaKey = dia.toLowerCase();
            const diaData = weekData.dias[diaKey];
            const diaElemento = document.createElement('div');
            diaElemento.className = 'dia-linea';
            diaElemento.style.gridTemplateColumns = "100px 40px 40px 1fr";

            diaElemento.innerHTML = `
                <span class="dia-nombre-lineal">${dia}</span>
                <button class="btn-cumplido-check ${diaData.cumplido === true ? 'active' : ''}" 
                        onclick="window.app.toggleDia('${diaKey}', true)" 
                        ${isCompletada ? 'disabled' : ''}>✓</button>
                <button class="btn-no-cumplido-check ${diaData.cumplido === false ? 'active' : ''}" 
                        onclick="window.app.toggleDia('${diaKey}', false)" 
                        ${isCompletada ? 'disabled' : ''}>✗</button>
                <div class="resultado-selector-lineal">
                    <select onchange="window.app.updateResultado('${diaKey}', this.value)" ${isCompletada ? 'disabled' : ''}>
                        <option value="">Resultado...</option>
                        <option value="positivo" ${diaData.resultado === 'positivo' ? 'selected' : ''}>Positivo</option>
                        <option value="negativo" ${diaData.resultado === 'negativo' ? 'selected' : ''}>Negativo</option>
                    </select>
                </div>`;
            container.appendChild(diaElemento);
        });
        this.actualizarBotonGuardar();
    }
    
    toggleDia(diaKey, cumplido) {
        const weekData = this.getCurrentWeekData();
        const dia = weekData.dias[diaKey];
        if (dia.cumplido === cumplido) {
            dia.cumplido = null;
        } else {
            dia.cumplido = cumplido;
        }
        this.saveData();
        this.renderDias();
        this.renderEstadisticas();
    }

    renderEstadisticas() {
        const weekData = this.getCurrentWeekData();
        const dias = Object.values(weekData.dias);
        const diasCumplidos = dias.filter(d => d.cumplido === true).length;
        const resultadosPositivos = dias.filter(d => d.resultado === 'positivo').length;
        const resultadosNegativos = dias.filter(d => d.resultado === 'negativo').length;
        const diasMarcados = dias.filter(d => d.cumplido !== null).length;
        const porcentajeCumplimiento = diasMarcados > 0 ? Math.round((diasCumplidos / diasMarcados) * 100) : 0;
        const efectividad = diasCumplidos > 0 ? Math.round(dias.filter(d => d.cumplido === true && d.resultado === 'positivo').length / diasCumplidos * 100) : 0;

        document.getElementById('diasCumplidos').textContent = diasCumplidos;
        document.getElementById('resultadosPositivos').textContent = resultadosPositivos;
        document.getElementById('resultadosNegativos').textContent = resultadosNegativos;
        document.getElementById('porcentajeCumplimiento').textContent = `${porcentajeCumplimiento}%`;
        document.getElementById('efectividad').textContent = `${efectividad}%`;
        this.renderChart(dias);
    }

    renderChart(dias) {
        const canvas = document.getElementById('chartCanvas');
        if (!canvas) return;
        if (this.chartInstance) this.chartInstance.destroy();
        const retoData = dias.map(d => d.cumplido === null ? null : (d.cumplido ? 1 : 0));
        const operativaData = dias.map(d => d.resultado === null ? null : (d.resultado === 'positivo' ? 1 : -1));
        this.chartInstance = new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: { labels: this.dias, datasets: [{ label: 'Cumplimiento Reto', data: retoData, borderColor: '#00f2ea', tension: 0.4 }, { label: 'Resultado Operativa', data: operativaData, borderColor: '#ef44bc', tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#b3b3b3', callback: v => { if (v === 1) return 'Positivo/Cumplido'; if (v === 0) return 'Neutral/No Cumplido'; if (v === -1) return 'Negativo'; return null; } } }, x: { ticks: { color: '#b3b3b3' } } }, plugins: { legend: { labels: { color: '#ffffff' } }, title: { display: true, text: 'Progreso Semanal: Reto vs Operativa', color: '#ffffff' } } }
        });
    }
    renderMonthlyStats() {
    const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const titulo = document.getElementById('currentMonth');
    const prevBtn = document.getElementById('prevMonthBtn');
    const nextBtn = document.getElementById('nextMonthBtn');
    const toggleBtn = document.getElementById('toggleTotalViewBtn');

    let semanasDelPeriodo;

    if (this.viendoTodo) {
        // --- MODO "VER TODO" ---
        titulo.textContent = 'Historial Completo';
        toggleBtn.textContent = 'Ver por Mes'; // Cambia el texto para ofrecer la acción de volver
        prevBtn.style.display = 'none'; // Ocultamos los botones de navegación
        nextBtn.style.display = 'none';
        semanasDelPeriodo = Object.keys(this.data).filter(k => this.data[k].completada);
    } else {
        // --- MODO MENSUAL ---
        titulo.textContent = `${monthNames[this.currentMonth]} ${this.currentYear}`;
        toggleBtn.textContent = 'Ver Todo'; // El texto vuelve a su estado original
        prevBtn.style.display = 'inline-block'; // Mostramos los botones de nuevo
        nextBtn.style.display = 'inline-block';
        semanasDelPeriodo = Object.keys(this.data).filter(k => 
            this.data[k].completada && 
            new Date(this.getWeekDates(k)).getMonth() === this.currentMonth && 
            new Date(this.getWeekDates(k)).getFullYear() === this.currentYear
        );
    }

    // --- El resto de la lógica de cálculo y renderizado no cambia ---
    let totalDiasCumplidos = 0, totalPositivos = 0, totalDiasMarcados = 0;
    semanasDelPeriodo.forEach(key => {
        const dias = Object.values(this.data[key].dias);
        totalDiasCumplidos += dias.filter(d => d.cumplido === true).length;
        totalPositivos += dias.filter(d => d.resultado === 'positivo').length;
        totalDiasMarcados += dias.filter(d => d.cumplido !== null).length;
    });

    document.getElementById('semanasDelMes').textContent = semanasDelPeriodo.length;
    document.getElementById('diasCumplidosMes').textContent = totalDiasCumplidos;
    document.getElementById('positivosMes').textContent = totalPositivos;
    document.getElementById('cumplimientoMes').textContent = `${totalDiasMarcados > 0 ? Math.round((totalDiasCumplidos / totalDiasMarcados) * 100) : 0}%`;
    
    this.renderMonthlyChart(semanasDelPeriodo);
}


 

    renderMonthlyChart(semanasDelMes) {
        const canvas = document.getElementById('monthlyChart');
        if (!canvas) return;
        if (this.monthlyChartInstance) this.monthlyChartInstance.destroy();
        const ctx = canvas.getContext('2d');
        if (semanasDelMes.length === 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#6c757d'; ctx.textAlign = 'center'; ctx.fillText('No hay datos para este mes', canvas.width / 2, canvas.height / 2);
            return;
        }
        const labels = semanasDelMes.map(k => `Semana ${k.split('-W')[1]}`);
        const cumplidosData = semanasDelMes.map(k => Object.values(this.data[k].dias).filter(d => d.cumplido === true).length);
        const positivosData = semanasDelMes.map(k => Object.values(this.data[k].dias).filter(d => d.resultado === 'positivo').length);
        this.monthlyChartInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Días Cumplidos', data: cumplidosData, backgroundColor: '#00f2ea' }, { label: 'Resultados Positivos', data: positivosData, backgroundColor: '#ef44bc' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#b3b3b3', stepSize: 1 } } }, plugins: { legend: { labels: { color: '#ffffff' } }, title: { display: true, text: 'Resumen Mensual por Semana', color: '#ffffff' } } }
        });
    }

    renderHistorial() {
        const container = document.getElementById('historialContainer');
        container.innerHTML = '';
        const semanas = Object.keys(this.data).filter(key => this.data[key].completada).sort((a, b) => b.localeCompare(a));
        if (semanas.length === 0) { container.innerHTML = '<p style="text-align: center; color: #6c757d;">No hay historial disponible</p>'; return; }
        semanas.forEach(key => {
            const semanaData = this.data[key];
            const dias = Object.values(semanaData.dias);
            const cumplidos = dias.filter(d => d.cumplido === true).length;
            const positivos = dias.filter(d => d.resultado === 'positivo').length;
            const porcentaje = dias.filter(d => d.cumplido !== null).length > 0 ? Math.round(cumplidos / dias.filter(d => d.cumplido !== null).length * 100) : 0;
            const item = document.createElement('div');
            item.className = 'historial-item';
            item.innerHTML = `<div><div class="historial-fecha">${this.formatWeekName(key)}</div><div class="historial-stats">${cumplidos}/5 cumplidos (${porcentaje}%), ${positivos} positivos</div><div class="historial-reto">${semanaData.reto || 'Sin reto'}</div></div><div><button class="btn-ver-semana" onclick="window.app.verSemana('${key}')">Ver</button><button class="btn-eliminar-semana" onclick="window.app.eliminarSemana('${key}')">Eliminar</button></div>`;
            container.appendChild(item);
        });
    }

    changeWeek(direction) {
        const [year, week] = this.currentWeek.split('-W');
        let newWeek = parseInt(week) + direction;
        let newYear = parseInt(year);
        if (newWeek < 1) { newWeek = 52; newYear--; } 
        else if (newWeek > 52) { newWeek = 1; newYear++; }
        this.currentWeek = `${newYear}-W${String(newWeek).padStart(2, '0')}`;
        this.renderAll();
    }

    changeMonth(direction) {
        this.currentMonth += direction;
        if (this.currentMonth < 0) { this.currentMonth = 11; this.currentYear--; }
        else if (this.currentMonth > 11) { this.currentMonth = 0; this.currentYear++; }
        this.renderMonthlyStats();
    }

    updateResultado(diaKey, resultado) {
        this.getCurrentWeekData().dias[diaKey].resultado = resultado || null;
        this.saveData();
        this.renderEstadisticas();
    }

    updateReto(reto) {
        if (!this.getCurrentWeekData().retoFijo) this.getCurrentWeekData().reto = reto;
        this.saveData();
    }

    fixReto() {
        const weekData = this.getCurrentWeekData();
        if (weekData.reto && !weekData.retoFijo) {
            weekData.retoFijo = true;
            this.saveData();
            this.loadCurrentWeekData();
        }
    }

    editarReto() {
        document.getElementById('retoInput').disabled = false;
        document.getElementById('retoInput').focus();
        document.getElementById('btnEditarReto').style.display = 'none';
        document.getElementById('btnGuardarReto').style.display = 'flex';
    }

    guardarReto() {
        const weekData = this.getCurrentWeekData();
        weekData.reto = document.getElementById('retoInput').value;
        weekData.retoFijo = true;
        this.saveData();
        this.loadCurrentWeekData();
    }

    loadCurrentWeekData() {
        const weekData = this.getCurrentWeekData();
        const retoInput = document.getElementById('retoInput');
        const btnEditar = document.getElementById('btnEditarReto');
        const btnGuardar = document.getElementById('btnGuardarReto');
        retoInput.value = weekData.reto;
        retoInput.disabled = weekData.retoFijo || weekData.completada;
        if (weekData.completada) {
            btnEditar.style.display = 'none';
            btnGuardar.style.display = 'none';
        } else if (weekData.retoFijo) {
            btnEditar.style.display = 'flex';
            btnGuardar.style.display = 'none';
        } else {
            btnEditar.style.display = 'none';
            btnGuardar.style.display = 'none';
        }
    }

    actualizarBotonGuardar() {
        const weekData = this.getCurrentWeekData();
        const diasMarcados = Object.values(weekData.dias).filter(d => d.cumplido !== null || d.resultado !== null).length;
        document.getElementById('btnGuardarHistorial').style.display = (weekData.reto && diasMarcados > 0 && !weekData.completada) ? 'block' : 'none';
    }

    guardarEnHistorial() {
        this.getCurrentWeekData().completada = true;
        this.saveData();
        alert('Semana finalizada y guardada en el historial.');
        this.renderAll();
    }

    verSemana(semanaKey) {
        this.currentWeek = semanaKey;
        this.renderAll();
        document.getElementById('Retos').scrollIntoView({ behavior: 'smooth' });
    }

    eliminarSemana(semanaKey) {
        if (confirm(`¿Estás seguro de que quieres eliminar la semana ${this.formatWeekName(semanaKey)}?`)) {
            delete this.data[semanaKey];
            this.saveData();
            this.renderAll();
        }
    }

    borrarHistorial() {
        if (confirm('¿Estás seguro de que quieres borrar todo el historial?')) {
            Object.keys(this.data).forEach(key => { if (this.data[key].completada) delete this.data[key]; });
            this.saveData();
            this.renderAll();
        }
    }

    getCurrentWeekKey() {
        const now = new Date();
        const year = now.getFullYear();
        const week = this.getWeekNumber(now);
        return `${year}-W${String(week).padStart(2, '0')}`;
    }

    getWeekDates(weekKey) {
        const [year, week] = weekKey.split('-W');
        const d = new Date(year, 0, 1 + (parseInt(week) - 1) * 7);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }

    getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    formatWeekName(weekKey) {
        const weekStart = this.getWeekDates(weekKey);
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekEnd.getDate() + 4);
        const formatDate = (date) => date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        return `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;
    }
}

// --- INICIALIZACIÓN CONTROLADA ---
let app; 

const originalOpenTab = window.openTab;
window.openTab = function(tabName) {
    originalOpenTab(tabName); 
    
    if (tabName === 'Retos' && !window.app) {
        window.app = new RetosSemanales();
    }
}


    </script>
</body>
</html>